<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm Premium</title>
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-bright: #fff3c5; --gold-mid: #d4af37; --gold-dark: #997b2f;
            --metallic-gold-gradient: linear-gradient(to bottom, var(--gold-bright) 0%, var(--gold-mid) 20%, var(--gold-dark) 50%, var(--gold-mid) 80%, var(--gold-bright) 100%);
        }
        body { font-family: 'Lato', sans-serif; background: linear-gradient(rgba(15, 15, 15, 0.9), rgba(10, 10, 10, 0.95)), url('https://www.transparenttextures.com/patterns/dark-wall.png'), #1a1a1a; color: #ccc; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .logo-container { margin-bottom: 25px; text-align: center; }
        h1.gold-sign { font-family: 'Cinzel', serif; font-weight: 900; font-size: 2.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; background: linear-gradient(to bottom, #fffde8 0%, #e3c472 20%, #d4af37 50%, #a0832a 51%, #d4af37 80%, #fffde8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.8)); }
        .subtitle-sign { font-family: 'Cinzel', serif; color: var(--gold-mid); font-size: 0.8rem; letter-spacing: 6px; text-transform: uppercase; margin-top: 5px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .box { background: linear-gradient(135deg, rgba(35,35,35,0.95), rgba(20,20,20,0.98)), url('https://www.transparenttextures.com/patterns/concrete-wall.png'); border: 2px solid; border-image: var(--metallic-gold-gradient) 1; box-shadow: 0 0 0 4px #121212, 0 25px 60px rgba(0,0,0,1), inset 0 0 40px rgba(0,0,0,0.8); padding: 30px; border-radius: 2px; width: 100%; max-width: 440px; box-sizing: border-box; margin-bottom: 25px; }
        label { color: var(--gold-mid); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; margin-top: 20px; text-shadow: 0 1px 2px rgba(0,0,0,1); display: flex; align-items: center; gap: 8px; }
        select, input { width: 100%; padding: 15px; background: #181818; border: 1px solid #333; border-bottom: 3px solid; border-image: var(--metallic-gold-gradient) 1; border-radius: 2px; color: var(--gold-bright); font-family: 'Lato', sans-serif; font-size: 16px; box-sizing: border-box; outline: none; box-shadow: inset 0 3px 10px rgba(0,0,0,0.8); transition: 0.3s; }
        select:focus, input:focus { background: #202020; box-shadow: inset 0 3px 10px rgba(0,0,0,0.9), 0 0 15px rgba(212, 175, 55, 0.2); }
        select option { background-color: #1a1a1a; color: var(--gold-bright); padding: 12px; }
        .radio-group { display: flex; gap: 2px; margin-top: 10px; background: #111; padding: 4px; box-shadow: inset 0 3px 8px rgba(0,0,0,0.8); border: 1px solid #333; border-radius: 4px; }
        .radio-lbl { flex: 1; padding: 14px; text-align: center; color: #777; cursor: pointer; transition: 0.3s; font-family: 'Cinzel', serif; font-weight: bold; font-size: 0.9em; text-transform: uppercase; border-radius: 2px; text-shadow: 0 1px 1px rgba(0,0,0,1); }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-lbl { background: var(--metallic-gold-gradient); color: #2a1a00; box-shadow: 0 2px 5px rgba(0,0,0,0.5); text-shadow: 0 1px 0 rgba(255,255,255,0.3); }
        
        .btn, .gold-btn { width: 100%; padding: 20px; margin-top: 20px; background: linear-gradient(to bottom, #ffeead 0%, #d4af37 20%, #a0832a 45%, #d4af37 55%, #ffeead 100%); border: 1px solid #a0832a; border-top: 1px solid #ffeead; border-radius: 3px; font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px; letter-spacing: 2px; cursor: pointer; color: #3a2a00; text-transform: uppercase; box-shadow: 0 8px 0 #4a3b0a, 0 15px 20px rgba(0,0,0,0.6), inset 0 2px 3px rgba(255,255,255,0.5); transition: 0.15s; position: relative; top: 0; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
        .btn:active, .gold-btn:active { top: 8px; box-shadow: 0 0 0 #4a3b0a, inset 0 3px 8px rgba(0,0,0,0.6); }
        .btn:disabled { background: #333; border:1px solid #444; color: #666; box-shadow: none; top: 4px; text-shadow: none; }
        
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.75em; color: #666; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        .admin-link:hover { color: var(--gold-mid); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        #msg { text-align: center; margin-top: 25px; font-weight: bold; min-height: 20px; font-size: 0.95em;}
        .success { color: #4caf50; text-shadow: 0 2px 4px rgba(0,0,0,1); } .error { color: #e74c3c; text-shadow: 0 2px 4px rgba(0,0,0,1); }
        #toast { visibility: hidden; min-width: 250px; background: #111; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; margin-left: -125px; border: 1px solid var(--gold-mid); box-shadow: 0 5px 20px rgba(0,0,0,0.8); opacity: 0; transition: 0.5s; font-family: 'Cinzel'; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { border-color: #c62828; color: #ff8a80; }
        
        #adminPanel, #paymentPanel { display: none; background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid var(--gold-mid); box-shadow: 0 20px 50px rgba(0,0,0,0.9); padding: 30px; border-radius: 4px; width: 100%; max-width: 95%; box-sizing: border-box; margin-top: 20px; }
        .admin-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding-bottom: 15px;}
        .admin-title { font-family: 'Cinzel'; color: var(--gold-mid); font-weight: bold; font-size: 1.1em; letter-spacing: 1px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .dashboard-stats { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .d-item { text-align: center; width: 32%; cursor: pointer; }
        .d-val { font-size: 1.4em; font-weight: bold; color: #fff; display: block; font-family: 'Cinzel'; }
        .d-lbl { font-size: 0.6em; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .btn-small { padding: 12px 10px; font-size: 0.7em; background: var(--metallic-gold-gradient); color: #2a1a00; border: 1px solid #8a6e18; border-radius: 3px; cursor: pointer; text-transform: uppercase; box-shadow: 0 3px 0 #4a3b0a, 0 5px 10px rgba(0,0,0,0.3); font-family: 'Lato', sans-serif; font-weight: 900; transition: 0.1s; position: relative; top:0; width: 100%; }
        .btn-small:active { top: 3px; box-shadow: 0 0 0 #4a3b0a; }
        .btn-small:hover { filter: brightness(1.1); }
        .btn-small.logout { background: #222; color: #999; border: 1px solid #333; box-shadow: 0 3px 0 #111; width: auto; padding: 12px 18px;}
        
        #authModal, #qrModal, #statsModal, #staffModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.96); display: none; justify-content: center; align-items: center; z-index: 999; }
        .auth-box, .qr-box, .stats-box, .staff-box { background: linear-gradient(135deg, #222 0%, #111 100%); border: 2px solid var(--gold-mid); padding: 40px; width: 340px; text-align: center; border-radius: 4px; box-shadow: 0 0 60px rgba(212, 175, 55, 0.15); max-height: 90vh; overflow-y: auto; }
        .qr-img { width: 250px; height: 250px; border: 5px solid #fff; border-radius: 10px; margin-bottom: 20px; display:block; margin: 0 auto 20px auto; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .stat-val { font-weight: bold; color: var(--gold-bright); }

        /* –ö–ê–õ–ï–ù–î–ê–†–¨ */
        .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-nav button { background: none; border: none; color: var(--gold-mid); font-size: 1.5em; cursor: pointer; }
        .cal-title { color: #fff; font-weight: bold; font-family: 'Cinzel'; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #555; border-radius: 4px; background: #1a1a1a; border: 1px solid #333; cursor: default; transition: 0.2s; position: relative;}
        .cal-head { color: var(--gold-mid); font-weight: bold; text-align: center; margin-bottom: 5px; font-size: 0.7em;}
        .cal-day.work { background: #2e7d32; color: #fff; border-color: #4caf50; box-shadow: 0 0 5px rgba(76, 175, 80, 0.4); }
        .cal-day.miss { background: #c62828; color: #fff; border-color: #f44336; }
        .cal-day.paid { background: #e91e63; color: #fff; border-color: #f48fb1; box-shadow: 0 0 8px rgba(233, 30, 99, 0.6); }
        .cal-day.paid::after { content: '‚ÇΩ'; position: absolute; bottom: 1px; right: 1px; font-size: 10px; font-weight: bold; color: #fff; }
        
        .staff-item { text-align: left; background: #181818; border-bottom: 1px solid #333; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .staff-name { color: #ccc; font-weight: bold; font-size: 0.9em; }
        .staff-fired { color: #e57373; text-decoration: line-through; }

        .search-box { position: relative; }
        #nSearch { cursor: pointer; width: 100%; padding: 15px; background: #181818; border: 1px solid #333; border-bottom: 3px solid; border-image: var(--metallic-gold-gradient) 1; color: var(--gold-bright); box-sizing: border-box; } 
        .custom-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #222; border: 1px solid #444; border-top: none; max-height: 250px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.8); border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }
        .dd-item { padding: 15px; border-bottom: 1px solid #333; color: #ccc; cursor: pointer; transition: 0.2s; }
        .dd-item:hover { background: #333; color: #fff; }
        .dd-item.selected { background: var(--metallic-gold-gradient); color: #111; font-weight: bold; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 25px; width: 25px; border-radius: 50%; background: var(--gold-mid); cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(212,175,55,0.8); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 5px; cursor: pointer; background: #333; border-radius: 2px; }

        /* –¢–ê–ë–õ–ò–¶–ê –ö–ê–°–°–ò–†–ê */
        .pay-table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #333; }
        .pay-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .pay-table th, .pay-table td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 0.8em; color: #ccc; }
        .pay-table th { background: #0c0c0c; color: var(--gold-mid); font-family: 'Cinzel'; position: sticky; top: 0; }
        .pay-table td.name-col { text-align: left; font-weight: bold; background: #111; position: sticky; left: 0; border-right: 2px solid var(--gold-mid); cursor: pointer; color: var(--gold-bright); }
        .pay-table td.name-col:hover { background: #222; }
        .pay-cell { width: 20px; height: 20px; line-height: 20px; }
        .bg-ok { background: #2e7d32; color: #fff; }
        .bg-miss { background: #c62828; color: #fff; }
        .bg-paid { background: #e91e63; color: #fff; font-weight: bold; }
        
        #payControl { display: none; margin-top: 20px; padding: 20px; background: #1a1a1a; border: 1px solid var(--gold-mid); }
    </style>
</head>
<body>

<div class="logo-container">
    <h1 class="gold-sign">WestProm</h1>
    <div class="subtitle-sign">Global Industries</div>
</div>

<div class="box">
    <form id="wForm">
        <label>üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <div class="search-box">
            <input type="text" id="nSearch" name="name" required placeholder="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞..." autocomplete="off">
            <div id="nDropdown" class="custom-dropdown"></div>
        </div>
        <label>üîí –ü–ò–ù-–∫–æ–¥</label>
        <input type="tel" id="nPin" name="pin" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ PIN" maxlength="6" style="text-align:center; letter-spacing:5px; font-size: 1.2em;" oninput="saveUser()">
        <label>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–ß–µ–ª.)</label>
        <select name="count" id="countSelect" onchange="saveUser()">
            <option value="1" selected>1 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="0.5">0.5 (–ü–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è)</option>
            <script>for(let i=2;i<=20;i++)document.write(`<option value="${i}">${i}</option>`)</script>
        </select>
        <label>‚öôÔ∏è –¢–∏–ø —Ä–∞–±–æ—Ç</label>
        <div class="radio-group">
            <input type="radio" id="t1" name="type" value="–î–Ω–µ–≤–∫–∞" checked><label for="t1" class="radio-lbl">–î–Ω–µ–≤–∫–∞</label>
            <input type="radio" id="t2" name="type" value="–û–±—ä–µ–º"><label for="t2" class="radio-lbl">–û–±—ä–µ–º</label>
        </div>
        
        <button class="btn" id="sBtn" style="margin-top: 40px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="gold-btn" type="button" onclick="showMyStats()">üèÜ –ú–æ—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </form>
    <div id="msg"></div>
    <div class="admin-link" onclick="openAuth()">–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
</div>

<div id="toast">–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</div>

<div id="adminPanel">
    <div class="admin-head">
        <span class="admin-title">ADMIN CONTROL</span>
        <button class="btn-small logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
    <div class="dashboard-stats">
        <div class="d-item"><span class="d-val" id="st-dnevka">-</span><span class="d-lbl">–î–Ω–µ–≤–∫–∞</span></div>
        <div class="d-item"><span class="d-val" id="st-volume">-</span><span class="d-lbl">–û–±—ä–µ–º</span></div>
        <div class="d-item" onclick="showDebtors()"><span class="d-val" id="st-miss" style="color:#e57373">-</span><span class="d-lbl">–ù–µ —Å–¥–∞–ª–∏ üëÅÔ∏è</span></div>
    </div>
    <button class="gold-btn" onclick="openStaffModal()" style="margin-bottom: 15px;">üë• –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–¢–ê–¢–û–ú</button>
    <div style="display:flex; gap:5px; justify-content:center; margin-bottom:15px;">
        <button class="btn-small" onclick="loadReq()">‚Üª</button>
        <button class="btn-small" onclick="dl('excel')">üíæ Excel</button>
        <button class="btn-small" onclick="dl('pdf')">üìÑ PDF</button>
    </div>
    <button class="gold-btn" onclick="showQR()" style="margin-top: 10px;">üì± –ü–û–ö–ê–ó–ê–¢–¨ QR-–ö–û–î</button>
    <div id="list" style="text-align:center; color:#666; font-size:0.9em; margin-top:20px;">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>
</div>

<div id="paymentPanel" style="max-width: 95%;">
    <div class="admin-head">
        <span class="admin-title" style="color:#e91e63">PAYMENT CONTROL</span>
        <button class="btn-small logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
    
    <div class="cal-nav">
        <button onclick="changePayMonth(-1)">&#9664;</button>
        <div class="cal-title" id="payTableMonth">...</div>
        <button onclick="changePayMonth(1)">&#9654;</button>
    </div>

    <div class="pay-table-container">
        <table class="pay-table" id="bigPayTable">
            </table>
    </div>

    <div id="payControl">
        <h3 style="color:var(--gold-mid); margin-top:0;" id="payControlName">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
        <div style="margin: 20px 0; text-align:center;">
            <label style="margin-top:0">–û–ø–ª–∞—Ç–∏—Ç—å –¥–æ: <span id="sliderVal" style="color:#fff; font-size:1.2em;">0</span> —á–∏—Å–ª–∞</label>
            <input type="range" id="paySlider" min="0" max="31" value="0" oninput="document.getElementById('sliderVal').innerText=this.value">
        </div>
        <button class="gold-btn" onclick="savePayment()" style="background: linear-gradient(to bottom, #f48fb1, #e91e63); border-color:#c2185b; color:#fff;">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-small" onclick="document.getElementById('payControl').style.display='none'" style="margin-top:10px; background:#333;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="authModal">
    <div class="auth-box">
        <h3 style="font-family:'Cinzel'; margin-top:0; font-size: 1.6em; letter-spacing: 2px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SECURITY</h3>
        <input type="password" id="pass" style="text-align:center; margin-bottom:30px; font-size:1.4em; letter-spacing: 5px;" placeholder="Password">
        <button class="btn" onclick="login()" style="margin-top:0; padding: 18px;">–í—Ö–æ–¥</button>
        <div style="margin-top:30px; color:#666; cursor:pointer; font-size:0.85em; text-transform:uppercase; letter-spacing: 1px;" onclick="document.getElementById('authModal').style.display='none'">–û–¢–ú–ï–ù–ê</div>
    </div>
</div>

<div id="qrModal" style="display:none;">
    <div class="qr-box">
        <h3 style="color:var(--gold-mid); margin-top:0; font-family:'Cinzel'; margin-bottom:20px;">SCAN TO ENTER</h3>
        <img id="qrImage" class="qr-img" src="" alt="QR Code">
        <div style="color:#aaa; font-size:0.8em; margin-bottom:20px;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
        <button class="btn-small" onclick="document.getElementById('qrModal').style.display='none'" style="width: auto; padding: 10px 30px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="staffModal" style="display:none;">
    <div class="staff-box">
        <h3 style="color:var(--gold-mid); margin-top:0; font-family:'Cinzel';">–®–¢–ê–¢ –°–û–¢–†–£–î–ù–ò–ö–û–í</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
             <input id="newEmpName" placeholder="–§–ò–û –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" style="padding:10px; font-size:0.9em;">
             <button class="btn-small" onclick="addEmployee()" style="width:auto; background: #2e7d32; color:#fff;">+</button>
        </div>
        <div id="staffList" style="max-height: 300px; overflow-y: auto; text-align: left;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button class="btn-small" onclick="document.getElementById('staffModal').style.display='none'" style="margin-top:20px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="statsModal" style="display:none;">
    <div class="stats-box">
        <div class="cal-nav">
            <button onclick="changeMonth(-1)">&#9664;</button>
            <div class="cal-title" id="calMonth">...</div>
            <button onclick="changeMonth(1)">&#9654;</button>
        </div>
        <div class="dashboard-stats" style="margin-bottom:10px; border:none; padding:0;">
             <div class="d-item" style="width:50%"><span class="d-val" id="my-dnevka">-</span><span class="d-lbl">–î–Ω–µ–≤–∫–∞</span></div>
             <div class="d-item" style="width:50%"><span class="d-val" id="my-volume">-</span><span class="d-lbl">–û–±—ä–µ–º</span></div>
        </div>
        <div id="calendarView"></div>
        <div style="text-align:center; color:#555; font-size:0.7em; margin-top:10px;">* –†–æ–∑–æ–≤—ã–º –æ—Ç–º–µ—á–µ–Ω—ã –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –¥–Ω–∏</div>
        <button class="btn-small" onclick="document.getElementById('statsModal').style.display='none'" style="margin-top:20px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    // üëáüëá –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ API üëáüëá
    const API = "https://script.google.com/macros/s/AKfycbznuu1glJr65Wp926QDxnPxAcibQxRl_h9gSzAXkR8HHmVUOeceoB9akZ5yxAZGsv71Sw/exec;
    // üëÜüëÜ ----------------------- üëÜüëÜ

    const ns = document.getElementById('nSearch');
    const dd = document.getElementById('nDropdown');
    const pin = document.getElementById('nPin');
    const countSelect = document.getElementById('countSelect');
    let debtorsList = [];
    let currentOffset = 0; 
    let statsData = null; 
    let allEmployees = []; 

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã
    let payOffset = 0;
    let payFullData = null;
    let payCurrentName = "";

    window.onload = () => {
        loadEmpSelect();
        if(localStorage.getItem('wp_pin')) { pin.value = localStorage.getItem('wp_pin'); }
        if(localStorage.getItem('wp_count')) countSelect.value = localStorage.getItem('wp_count');
        
        let auth = localStorage.getItem('wp_admin_auth');
        if(auth === 'main') { document.getElementById('adminPanel').style.display = 'block'; loadReq(); }
        if(auth === 'payment') { document.getElementById('paymentPanel').style.display = 'block'; loadPayTable(); }
    };

    function loadEmpSelect() {
        ns.placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get_employees").then(r=>r.json()).then(d=>{
            if(d.data) {
                allEmployees = d.data;
                renderDropdown(allEmployees, dd, ns, (val)=>{ ns.value=val; saveUser(); });
                let saved = localStorage.getItem('wp_user');
                if(saved) ns.value = saved; else ns.placeholder = "üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è...";
            }
        });
    }

    function renderDropdown(list, ddEl, inputEl, cb) {
        ddEl.innerHTML = "";
        if(list.length === 0) { ddEl.innerHTML = "<div class='dd-item' style='cursor:default; color:#777'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>"; return; }
        list.forEach(name => {
            let div = document.createElement('div');
            div.className = "dd-item";
            div.innerText = name;
            div.onclick = () => { inputEl.value = name; ddEl.style.display = 'none'; cb(name); };
            ddEl.appendChild(div);
        });
    }

    ns.addEventListener('input', function() { renderDropdown(allEmployees.filter(n=>n.toLowerCase().includes(this.value.toLowerCase())), dd, ns, (val)=>{ns.value=val; saveUser();}); dd.style.display='block'; });
    ns.addEventListener('focus', function() { renderDropdown(allEmployees, dd, ns, (val)=>{ns.value=val; saveUser();}); dd.style.display='block'; });
    document.addEventListener('click', function(e) { if (!ns.contains(e.target) && !dd.contains(e.target)) dd.style.display = 'none'; });

    function saveUser() { localStorage.setItem('wp_user', ns.value); localStorage.setItem('wp_pin', pin.value); localStorage.setItem('wp_count', countSelect.value); }

    function showMyStats() {
        var p = pin.value; var n = ns.value;
        if(!p || !n) { showToast("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –∏ –≤–≤–µ–¥–∏—Ç–µ –ü–ò–ù", true); return; }
        document.getElementById('statsModal').style.display='flex';
        currentOffset = 0;
        loadStats();
    }
    
    function changeMonth(delta) { currentOffset += delta; loadStats(); }
    
    function loadStats() {
        var p = pin.value; var n = ns.value;
        document.getElementById('calendarView').innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get_user_stats&name=" + encodeURIComponent(n) + "&pin=" + p + "&offset=" + currentOffset)
        .then(r=>r.json()).then(d => {
             if(d.result === "success") {
                 statsData = d.stats;
                 renderCalendar(); 
             } else { document.getElementById('calendarView').innerHTML = "–û—à–∏–±–∫–∞: " + d.message; }
        });
    }
    
    function renderCalendar() {
        if(!statsData) return;
        document.getElementById('calMonth').innerText = statsData.label;
        let calHtml = '<div class="calendar-grid">';
        let days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
        days.forEach(d => calHtml += `<div class="cal-head">${d}</div>`);
        for(let i=1; i<=statsData.daysInMonth; i++) {
             let cls = "cal-day";
             if(statsData.workDays.includes(i)) cls += " work"; 
             else if(statsData.limitDay > 0 && i <= statsData.limitDay) cls += " miss";
             if(i <= statsData.paidLimit) cls += " paid";
             calHtml += `<div class="${cls}">${i}</div>`;
        }
        calHtml += '</div>';
        document.getElementById('calendarView').innerHTML = calHtml;
    }

    document.getElementById('wForm').onsubmit = e => {
        e.preventDefault();
        let b = document.getElementById('sBtn'); b.disabled=true; b.innerText="–û—Ç–ø—Ä–∞–≤–∫–∞...";
        let fd = new FormData(document.getElementById('wForm'));
        let p = new URLSearchParams(); p.append('action','create');
        for(let [k,v] of fd) p.append(k,v);
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d=>{
            b.disabled=false; b.innerText="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç";
            if(d.result==="success"){
                showToast("‚úÖ –û–¢–ß–ï–¢ –û–¢–ü–†–ê–í–õ–ï–ù");
                setTimeout(()=>{ document.getElementById('wForm').reset(); ns.value=localStorage.getItem('wp_user'); pin.value=localStorage.getItem('wp_pin'); if(localStorage.getItem('wp_count')) countSelect.value = localStorage.getItem('wp_count'); else countSelect.value = "1"; }, 1000);
            } else showToast(d.message, true); 
        }).catch(()=>{ b.disabled=false; b.innerText="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç"; showToast("‚ùå –û–®–ò–ë–ö–ê –°–í–Ø–ó–ò", true); });
    };

    function showToast(text, isErr=false) { var t = document.getElementById("toast"); t.innerText = text; t.className = "show" + (isErr ? " error" : ""); setTimeout(()=>{ t.className = t.className.replace("show", ""); }, 3000); }

    function openAuth() { document.getElementById('authModal').style.display = 'flex'; }
    function login() {
        let p = document.getElementById('pass').value;
        if(p==="westprom123") {
            localStorage.setItem('wp_admin_auth', 'main');
            document.getElementById('authModal').style.display='none';
            document.getElementById('adminPanel').style.display='block'; loadReq();
        } else if(p==="money777") {
            localStorage.setItem('wp_admin_auth', 'payment');
            document.getElementById('authModal').style.display='none';
            document.getElementById('paymentPanel').style.display='block'; loadPayTable();
        } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    }
    function logout() { if(confirm("–í—ã–π—Ç–∏?")) { localStorage.removeItem('wp_admin_auth'); location.reload(); } }

    // --- –ê–î–ú–ò–ù–ö–ê ---
    function loadReq() {
        let l = document.getElementById('list'); l.innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get").then(r=>r.json()).then(d=>{
            if(d.stats) {
                document.getElementById('st-dnevka').innerText = d.stats.dnevka;
                document.getElementById('st-volume').innerText = d.stats.volume;
                document.getElementById('st-miss').innerText = d.stats.missing;
                debtorsList = d.stats.missingNames || [];
            }
            l.innerHTML="";
            if(!d.data || !d.data.length) { l.innerHTML="<div style='margin-top:15px; opacity:0.6'>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>"; return;}
            d.data.reverse().forEach(i=>{
                let div = document.createElement('div'); div.className='req-card';
                div.innerHTML=`
                <div><span style="font-size:0.8em;color:#666;float:right">${i['–î–∞—Ç–∞']}</span><b class="req-info">${i['–§–∞–º–∏–ª–∏—è –ò–º—è']}</b></div>
                <div style="font-size:0.9em;color:var(--gold-mid);margin-top:5px">–õ—é–¥–µ–π: <b style="color:#fff">${i['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']}</b> ‚Ä¢ ${i['–í–∏–¥ —Ä–∞–±–æ—Ç']}</div>
                <div class="req-btns" style="display:flex; margin-top:10px;">
                    <button class="btn-act btn-yes" onclick="upd('${i.ID}','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">‚úÖ</button>
                    <button class="btn-act btn-no" onclick="upd('${i.ID}','–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')">‚ùå</button>
                    <button class="btn-act btn-del" onclick="del('${i.ID}')">üóëÔ∏è</button>
                </div>`;
                l.appendChild(div);
            });
        });
    }
    function upd(id, st) { if(confirm(st+"?")) { let p = new URLSearchParams(); p.append('action','update'); p.append('id',id); p.append('status',st); fetch(API,{method:'POST', body:p}).then(()=>loadReq()); } }
    function del(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { let p = new URLSearchParams(); p.append('action','delete_row'); p.append('id',id); fetch(API,{method:'POST', body:p}).then(()=>loadReq()); } }
    function showDebtors() { if(debtorsList.length) alert("‚ö†Ô∏è –ù–ï –°–î–ê–õ–ò:\n\n"+debtorsList.join("\n")); else alert("–í—Å–µ —Å–¥–∞–ª–∏!"); }
    function dl(type) { const btn = event.target; const oldText = btn.innerText; btn.innerText = "‚è≥"; fetch(API + "?action=get_" + type).then(r => r.json()).then(d => { btn.innerText = oldText; if(d.result === "success" && d.file) { const link = document.createElement('a'); link.href = "data:" + d.mime + ";base64," + d.file; link.download = d.name; document.body.appendChild(link); link.click(); document.body.removeChild(link); } else alert("–û—à–∏–±–∫–∞"); }).catch(e => { btn.innerText = oldText; alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }); }
    function showQR() { var url = window.location.href; var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(url); document.getElementById('qrImage').src = qrUrl; document.getElementById('qrModal').style.display = 'flex'; }
    function openStaffModal() { document.getElementById('staffModal').style.display = 'flex'; loadStaffList(); }
    function loadStaffList() { let sl = document.getElementById('staffList'); sl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞..."; fetch(API + "?action=get_staff_list").then(r=>r.json()).then(d=>{ if(d.result === "success") { sl.innerHTML = ""; d.staff.forEach(s => { let isFired = (s.status === "Fired"); let nameClass = isFired ? "staff-name staff-fired" : "staff-name"; let btnHtml = isFired ? `<button class="btn-small" onclick="restoreEmp('${s.name}')" style="width:auto; padding:5px 10px; background:#2e7d32;">–í–ï–†–ù–£–¢–¨</button>` : `<button class="btn-small" onclick="fireEmp('${s.name}')" style="width:auto; padding:5px 10px; background:#c62828;">–£–í–û–õ–ò–¢–¨</button>`; let div = document.createElement('div'); div.className = "staff-item"; div.innerHTML = `<span class="${nameClass}">${s.name} ${isFired ? '<br><span style="font-size:0.7em;color:#777">–£–≤–æ–ª–µ–Ω: '+s.firedDate+'</span>' : ''}</span> ${btnHtml}`; sl.appendChild(div); }); } else sl.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }); }
    function addEmployee() { let n = document.getElementById('newEmpName').value; if(!n) return; if(!confirm("–î–æ–±–∞–≤–∏—Ç—å: " + n + "?")) return; let p = new URLSearchParams(); p.append('action','add_employee'); p.append('name',n); fetch(API, {method:'POST', body:p}).then(() => { document.getElementById('newEmpName').value = ""; loadStaffList(); loadEmpSelect(); }); }
    function fireEmp(name) { if(!confirm("–£–≤–æ–ª–∏—Ç—å " + name + "?")) return; let p = new URLSearchParams(); p.append('action','fire_employee'); p.append('name',name); fetch(API, {method:'POST', body:p}).then(() => { loadStaffList(); loadEmpSelect(); }); }
    function restoreEmp(name) { if(!confirm("–í–µ—Ä–Ω—É—Ç—å " + name + "?")) return; let p = new URLSearchParams(); p.append('action','restore_employee'); p.append('name',name); fetch(API, {method:'POST', body:p}).then(() => { loadStaffList(); loadEmpSelect(); }); }

    // --- –ö–ê–°–°–ò–† ---
    function changePayMonth(delta) { payOffset += delta; loadPayTable(); }
    
    function loadPayTable() {
        document.getElementById('bigPayTable').innerHTML = "<tr><td style='padding:20px'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
        fetch(API + "?action=get_all_stats_month&offset=" + payOffset).then(r=>r.json()).then(d=>{
            if(d.result === "success") {
                payFullData = d;
                document.getElementById('payTableMonth').innerText = d.monthLabel;
                renderBigTable();
            } else {
                document.getElementById('bigPayTable').innerHTML = "–û—à–∏–±–∫–∞: " + d.message;
            }
        });
    }

    function renderBigTable() {
        if(!payFullData) return;
        let t = document.getElementById('bigPayTable');
        t.innerHTML = "";
        
        // –®–∞–ø–∫–∞
        let hRow = document.createElement('tr');
        hRow.innerHTML = "<th>–§–ò–û</th>";
        for(let i=1; i<=payFullData.daysInMonth; i++) { hRow.innerHTML += `<th>${i}</th>`; }
        hRow.innerHTML += "<th>–î–Ω</th><th>–°–¥</th>";
        t.appendChild(hRow);
        
        // –†—è–¥—ã
        let names = Object.keys(payFullData.stats).sort();
        names.forEach(name => {
            let user = payFullData.stats[name];
            let row = document.createElement('tr');
            
            // –ò–º—è
            let nameCell = document.createElement('td');
            nameCell.className = "name-col";
            nameCell.innerText = name;
            nameCell.onclick = () => openPaymentControl(name, user.paidLimit);
            row.appendChild(nameCell);
            
            // –î–Ω–∏
            for(let i=1; i<=payFullData.daysInMonth; i++) {
                let cell = document.createElement('td');
                cell.className = "pay-cell";
                
                let val = "";
                let bg = "";
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –û–ø–ª–∞—á–µ–Ω–æ
                if (i <= user.paidLimit) {
                    val = "‚ÇΩ"; bg = "bg-paid";
                } else {
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –†–∞–±–æ—Ç–∞–ª
                    if (user.days[i]) {
                        val = user.days[i]; bg = "bg-ok";
                    } 
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ü—Ä–æ–≥—É–ª (–µ—Å–ª–∏ –¥–æ –ª–∏–º–∏—Ç–∞ –¥–Ω–µ–π)
                    else if (payFullData.limitDay > 0 && i <= payFullData.limitDay) {
                         bg = "bg-miss";
                    }
                }
                
                if(bg) cell.classList.add(bg);
                cell.innerText = val;
                row.appendChild(cell);
            }
            
            // –ò—Ç–æ–≥–∏
            row.innerHTML += `<td>${user.totalD}</td><td>${user.totalV}</td>`;
            t.appendChild(row);
        });
    }
    
    function openPaymentControl(name, limit) {
        payCurrentName = name;
        document.getElementById('payControlName').innerText = name;
        document.getElementById('paySlider').max = payFullData.daysInMonth;
        document.getElementById('paySlider').value = limit;
        document.getElementById('sliderVal').innerText = limit;
        document.getElementById('payControl').style.display = 'block';
        document.getElementById('payControl').scrollIntoView({behavior: "smooth"});
    }
    
    function savePayment() {
        let limit = document.getElementById('paySlider').value;
        let month = document.getElementById('payTableMonth').innerText;
        
        let btn = event.target; btn.innerText = "‚è≥...";
        let p = new URLSearchParams(); 
        p.append('action','save_payment'); 
        p.append('name', payCurrentName); 
        p.append('month', month);
        p.append('limit', limit);
        
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d=>{
            btn.innerText = "üíæ –°–û–•–†–ê–ù–ò–¢–¨";
            document.getElementById('payControl').style.display = 'none';
            loadPayTable(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        });
    }
</script>

</body>
</html>
