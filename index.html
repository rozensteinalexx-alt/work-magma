<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm Premium</title>
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <style>
        :root {
            --gold-bright: #fff3c5; --gold-mid: #d4af37; --gold-dark: #997b2f;
            --metallic-gold-gradient: linear-gradient(to bottom, var(--gold-bright) 0%, var(--gold-mid) 20%, var(--gold-dark) 50%, var(--gold-mid) 80%, var(--gold-bright) 100%);
        }
        body { font-family: sans-serif; background: #1a1a1a; color: #ccc; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .logo-container { margin-bottom: 25px; text-align: center; }
        h1.gold-sign { font-weight: 900; font-size: 2.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; background: linear-gradient(to bottom, #fffde8 0%, #e3c472 20%, #d4af37 50%, #a0832a 51%, #d4af37 80%, #fffde8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle-sign { color: var(--gold-mid); font-size: 0.8rem; letter-spacing: 6px; text-transform: uppercase; margin-top: 5px; font-weight: 700; }
        .box { background: #222; border: 2px solid var(--gold-mid); padding: 30px; border-radius: 4px; width: 100%; max-width: 440px; box-sizing: border-box; margin-bottom: 25px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        label { color: var(--gold-mid); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; margin-top: 20px; }
        select, input { width: 100%; padding: 15px; background: #181818; border: 1px solid #333; border-bottom: 2px solid var(--gold-mid); color: var(--gold-bright); font-size: 16px; box-sizing: border-box; outline: none; }
        .radio-group { display: flex; gap: 2px; margin-top: 10px; background: #111; padding: 4px; border: 1px solid #333; }
        .radio-lbl { flex: 1; padding: 14px; text-align: center; color: #777; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-lbl { background: var(--gold-mid); color: #000; }
        .btn, .gold-btn { width: 100%; padding: 20px; margin-top: 20px; background: linear-gradient(to bottom, #ffeead, #d4af37); border: 1px solid #a0832a; font-weight: 900; font-size: 18px; cursor: pointer; color: #3a2a00; text-transform: uppercase; }
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.75em; color: #666; cursor: pointer; text-transform: uppercase; }
        
        #toast { visibility: hidden; min-width: 250px; background: #111; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; margin-left: -125px; border: 1px solid var(--gold-mid); }
        #toast.show { visibility: visible; }
        
        #adminPanel, #paymentPanel { display: none; background: #111; border: 1px solid var(--gold-mid); padding: 30px; width: 100%; max-width: 95%; box-sizing: border-box; margin-top: 20px; }
        .admin-head { display: flex; justify-content: space-between; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .btn-small { padding: 10px; font-size: 0.7em; background: var(--gold-mid); color: #000; border: none; cursor: pointer; font-weight: bold; }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        #authModal, #statsModal, #staffModal, #qrModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 999; }
        .auth-box, .stats-box, .staff-box, .qr-box { background: #111; border: 2px solid var(--gold-mid); padding: 40px; width: 340px; text-align: center; max-height: 90vh; overflow-y: auto; }

        /* –ü–æ–∏—Å–∫ */
        .search-box { position: relative; }
        .custom-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #222; border: 1px solid var(--gold-mid); max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .dd-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; }
        .dd-item:hover { background: #333; }

        /* –¢–∞–±–ª–∏—Ü–∞ –ö–∞—Å—Å–∏—Ä–∞ */
        .pay-table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #333; }
        .pay-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .pay-table th, .pay-table td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 0.8em; color: #ccc; }
        .pay-table th { background: #000; color: var(--gold-mid); position: sticky; top: 0; }
        .pay-table td.name-col { text-align: left; font-weight: bold; background: #111; position: sticky; left: 0; border-right: 2px solid var(--gold-mid); cursor: pointer; color: #fff; }
        .bg-ok { background: #2e7d32; color: #fff; }
        .bg-miss { background: #c62828; color: #fff; }
        .bg-paid { background: #e91e63; color: #fff; font-weight: bold; }
        
        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #333; font-size: 0.8em; }
        .cal-day.work { background: #2e7d32; color: #fff; }
        .cal-day.miss { background: #c62828; color: #fff; }
        .cal-day.paid { background: #e91e63; color: #fff; position: relative; }
        .cal-day.paid::after { content: '‚ÇΩ'; position: absolute; bottom: 1px; right: 2px; font-size: 10px; font-weight: bold; }
        
        /* –°–ª–∞–π–¥–µ—Ä */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: var(--gold-mid); cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; }
        
        #payControl { display: none; margin-top: 20px; padding: 20px; background: #1a1a1a; border: 1px solid var(--gold-mid); }
    </style>
</head>
<body>

<div class="logo-container">
    <h1 class="gold-sign">WestProm</h1>
    <div class="subtitle-sign">Global Industries</div>
</div>

<div class="box">
    <form id="wForm">
        <label>üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <div class="search-box">
            <input type="text" id="nSearch" name="name" required placeholder="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞..." autocomplete="off">
            <div id="nDropdown" class="custom-dropdown"></div>
        </div>
        
        <label>üîí –ü–ò–ù-–∫–æ–¥</label>
        <input type="tel" id="nPin" name="pin" required placeholder="PIN" maxlength="6" style="text-align:center; letter-spacing:5px; font-size: 1.2em;" oninput="saveUser()">
        
        <label>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <select name="count" id="countSelect" onchange="saveUser()">
            <option value="1" selected>1 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="0.5">0.5 (–ü–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è)</option>
            <script>for(let i=2;i<=20;i++)document.write(`<option value="${i}">${i}</option>`)</script>
        </select>
        
        <label>‚öôÔ∏è –¢–∏–ø —Ä–∞–±–æ—Ç</label>
        <div class="radio-group">
            <input type="radio" id="t1" name="type" value="–î–Ω–µ–≤–∫–∞" checked><label for="t1" class="radio-lbl">–î–Ω–µ–≤–∫–∞</label>
            <input type="radio" id="t2" name="type" value="–û–±—ä–µ–º"><label for="t2" class="radio-lbl">–û–±—ä–µ–º</label>
        </div>
        
        <button class="btn" id="sBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="gold-btn" type="button" onclick="showMyStats()">üèÜ –ú–æ—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </form>
    <div id="msg"></div>
    <div class="admin-link" onclick="openAuth()">–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
</div>

<div id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

<div id="authModal">
    <div class="auth-box">
        <h3>–í–•–û–î</h3>
        <input type="password" id="pass" style="text-align:center; margin-bottom:20px;" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="login()" style="margin-top:0;">–í–æ–π—Ç–∏</button>
        <div style="margin-top:20px; cursor:pointer; color:#777;" onclick="document.getElementById('authModal').style.display='none'">–û—Ç–º–µ–Ω–∞</div>
    </div>
</div>

<div id="statsModal" style="display:none;">
    <div class="stats-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-small" onclick="changeMonth(-1)"><</button>
            <h3 id="calMonth" style="margin:0; color:#fff;">...</h3>
            <button class="btn-small" onclick="changeMonth(1)">></button>
        </div>
        <div style="display:flex; justify-content:space-around; margin:15px 0; border-bottom:1px solid #333; padding-bottom:10px;">
             <div><span style="font-size:1.5em; font-weight:bold; color:#fff;" id="my-dnevka">-</span><br><span style="font-size:0.7em; color:#777;">–î–ù–ï–í–ö–ê</span></div>
             <div><span style="font-size:1.5em; font-weight:bold; color:#fff;" id="my-volume">-</span><br><span style="font-size:0.7em; color:#777;">–û–ë–™–ï–ú</span></div>
        </div>
        <div id="calendarView"></div>
        <button class="btn-small" onclick="document.getElementById('statsModal').style.display='none'" style="margin-top:20px; width:100%;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="adminPanel">
    <div class="admin-head"><span style="color:var(--gold-mid); font-weight:bold;">ADMIN</span> <button class="btn-small" onclick="logout()">–í—ã—Ö–æ–¥</button></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <div style="text-align:center"><span id="st-dnevka" style="font-size:1.5em; font-weight:bold; color:#fff">-</span><br><span style="font-size:0.7em; color:#777">–î–ù–ï–í–ö–ê</span></div>
        <div style="text-align:center"><span id="st-volume" style="font-size:1.5em; font-weight:bold; color:#fff">-</span><br><span style="font-size:0.7em; color:#777">–û–ë–™–ï–ú</span></div>
        <div style="text-align:center"><span id="st-miss" style="font-size:1.5em; font-weight:bold; color:#e57373">-</span><br><span style="font-size:0.7em; color:#777">–î–û–õ–ì</span></div>
    </div>
    <button class="gold-btn" onclick="openStaffModal()">üë• –®–¢–ê–¢</button>
    <div style="display:flex; gap:5px; justify-content:center; margin-top:10px;">
        <button class="btn-small" onclick="loadReq()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-small" onclick="dl('excel')">Excel</button>
        <button class="btn-small" onclick="dl('pdf')">PDF</button>
    </div>
    <div id="list" style="margin-top:20px; text-align:center; color:#555;">...</div>
</div>

<div id="paymentPanel">
    <div class="admin-head"><span style="color:#e91e63; font-weight:bold;">–§–ò–ù–ê–ù–°–´</span> <button class="btn-small" onclick="logout()">–í—ã—Ö–æ–¥</button></div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button class="btn-small" onclick="changePayMonth(-1)"><</button>
        <span id="payTableMonth" style="color:#fff; font-weight:bold;">...</span>
        <button class="btn-small" onclick="changePayMonth(1)">></button>
    </div>

    <div class="pay-table-container">
        <table class="pay-table" id="bigPayTable"></table>
    </div>

    <div id="payControl">
        <h3 style="color:var(--gold-mid); margin-top:0;" id="payControlName">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
        <div style="margin: 20px 0; text-align:center;">
            <label style="margin-top:0">–û–ø–ª–∞—Ç–∏—Ç—å –¥–æ: <span id="sliderVal" style="color:#fff; font-size:1.2em;">0</span></label>
            <input type="range" id="paySlider" min="0" max="31" value="0" oninput="document.getElementById('sliderVal').innerText=this.value">
        </div>
        <button class="gold-btn" onclick="savePayment()" style="background: linear-gradient(to bottom, #f48fb1, #e91e63); border:none; color:#fff;">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-small" onclick="document.getElementById('payControl').style.display='none'" style="margin-top:10px; width:100%; background:#333;">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="staffModal" style="display:none;">
    <div class="staff-box">
        <h3>–®–¢–ê–¢</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
             <input id="newEmpName" placeholder="–§–ò–û" style="padding:10px;">
             <button class="btn-small" onclick="addEmployee()" style="background:#2e7d32; color:#fff;">+</button>
        </div>
        <div id="staffList" style="text-align:left;">...</div>
        <button class="btn-small" onclick="document.getElementById('staffModal').style.display='none'" style="margin-top:20px; width:100%;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    // üëáüëá –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ –ù–ò–ñ–ï üëáüëá
    const API = "https://script.google.com/macros/s/AKfycbyL0fdqnjIUw6JKSR0JNkPc3912TnGhRCih6IkDEg5dhTQIT0r_uQfmczCE91jd6q7n0A/exec";
    // üëÜüëÜ ----------------------- üëÜüëÜ

    const ns = document.getElementById('nSearch');
    const dd = document.getElementById('nDropdown');
    const pin = document.getElementById('nPin');
    const countSelect = document.getElementById('countSelect');
    
    let allEmployees = [];
    let currentOffset = 0;
    let payOffset = 0;
    let payCurrentName = "";
    let payFullData = null;
    let statsData = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        try {
            loadEmpSelect();
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            if(localStorage.getItem('wp_pin')) pin.value = localStorage.getItem('wp_pin');
            if(localStorage.getItem('wp_count')) countSelect.value = localStorage.getItem('wp_count');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            let auth = localStorage.getItem('wp_admin_auth');
            if(auth === 'main') { document.getElementById('adminPanel').style.display = 'block'; loadReq(); }
            if(auth === 'payment') { document.getElementById('paymentPanel').style.display = 'block'; loadPayTable(); }
        } catch(e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
        }
    };

    // --- –ö–õ–ò–ï–ù–¢–°–ö–ê–Ø –ß–ê–°–¢–¨ ---
    function loadEmpSelect() {
        ns.placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get_employees")
        .then(r => r.json())
        .then(d => {
            if(d.data) {
                allEmployees = d.data;
                renderDropdown(allEmployees);
                let saved = localStorage.getItem('wp_user');
                if(saved) ns.value = saved; else ns.placeholder = "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞...";
            }
        })
        .catch(e => {
            ns.placeholder = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏!";
            console.error("API Error:", e);
        });
    }

    function renderDropdown(list) {
        dd.innerHTML = "";
        if(list.length === 0) { dd.innerHTML = "<div class='dd-item' style='color:#777'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>"; return; }
        list.forEach(name => {
            let div = document.createElement('div');
            div.className = "dd-item";
            div.innerText = name;
            div.onclick = () => { ns.value = name; dd.style.display = 'none'; saveUser(); };
            dd.appendChild(div);
        });
    }

    // –ü–æ–∏—Å–∫
    ns.addEventListener('input', function() { 
        let val = this.value.toLowerCase();
        let filtered = allEmployees.filter(n => n.toLowerCase().includes(val));
        renderDropdown(filtered);
        dd.style.display = 'block'; 
    });
    ns.addEventListener('focus', function() { renderDropdown(allEmployees); dd.style.display = 'block'; });
    document.addEventListener('click', function(e) { if (!ns.contains(e.target) && !dd.contains(e.target)) dd.style.display = 'none'; });

    function saveUser() { localStorage.setItem('wp_user', ns.value); localStorage.setItem('wp_pin', pin.value); localStorage.setItem('wp_count', countSelect.value); }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞
    document.getElementById('wForm').onsubmit = function(e) {
        e.preventDefault();
        let b = document.getElementById('sBtn');
        b.disabled = true; b.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
        
        let fd = new FormData(document.getElementById('wForm'));
        let p = new URLSearchParams(); 
        p.append('action', 'create');
        for(let [k,v] of fd) p.append(k,v);
        
        fetch(API, {method:'POST', body:p})
        .then(r=>r.json())
        .then(d => {
            b.disabled = false; b.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨";
            if(d.result === "success") {
                showToast("‚úÖ –£—Å–ø–µ—à–Ω–æ!");
                setTimeout(() => { 
                    document.getElementById('wForm').reset(); 
                    ns.value = localStorage.getItem('wp_user'); 
                    pin.value = localStorage.getItem('wp_pin'); 
                    countSelect.value = "1";
                }, 1000);
            } else {
                showToast("‚õî " + d.message, true);
            }
        })
        .catch(() => {
            b.disabled = false; b.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨";
            showToast("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏", true);
        });
    };

    function showToast(text, isErr) {
        let t = document.getElementById("toast");
        t.innerText = text;
        t.className = "show";
        t.style.borderColor = isErr ? "#c62828" : "#d4af37";
        setTimeout(() => { t.className = ""; }, 3000);
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    function showMyStats() {
        let n = ns.value; let p = pin.value;
        if(!n || !p) { showToast("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –ò–º—è –∏ –ü–ò–ù", true); return; }
        document.getElementById('statsModal').style.display = 'flex';
        currentOffset = 0;
        loadStats();
    }

    function changeMonth(d) { currentOffset += d; loadStats(); }

    function loadStats() {
        document.getElementById('calendarView').innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        let n = ns.value; let p = pin.value;
        fetch(API + `?action=get_user_stats&name=${encodeURIComponent(n)}&pin=${p}&offset=${currentOffset}`)
        .then(r=>r.json())
        .then(d => {
            if(d.result === "success") {
                statsData = d.stats;
                renderUserCalendar();
            } else {
                document.getElementById('calendarView').innerHTML = d.message;
            }
        });
    }

    function renderUserCalendar() {
        if(!statsData) return;
        document.getElementById('calMonth').innerText = statsData.label;
        document.getElementById('my-dnevka').innerText = statsData.dnevka;
        document.getElementById('my-volume').innerText = statsData.volume;
        
        let html = '<div class="calendar-grid">';
        for(let i=1; i<=statsData.daysInMonth; i++) {
            let cls = "cal-day";
            if(statsData.workDays.includes(i)) cls += " work";
            else if(statsData.limitDay > 0 && i <= statsData.limitDay) cls += " miss";
            if(i <= statsData.paidLimit) cls += " paid";
            html += `<div class="${cls}">${i}</div>`;
        }
        html += '</div>';
        document.getElementById('calendarView').innerHTML = html;
    }

    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
    function openAuth() { document.getElementById('authModal').style.display = 'flex'; }
    function login() {
        let p = document.getElementById('pass').value;
        if(p==="westprom123") {
            localStorage.setItem('wp_admin_auth', 'main');
            location.reload();
        } else if(p==="money777") {
            localStorage.setItem('wp_admin_auth', 'payment');
            location.reload();
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        }
    }
    function logout() { 
        if(confirm("–í—ã–π—Ç–∏?")) {
            localStorage.removeItem('wp_admin_auth');
            location.reload();
        }
    }

    // --- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ---
    function loadReq() {
        let list = document.getElementById('list');
        list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get").then(r=>r.json()).then(d => {
            if(d.stats) {
                document.getElementById('st-dnevka').innerText = d.stats.dnevka;
                document.getElementById('st-volume').innerText = d.stats.volume;
                document.getElementById('st-miss').innerText = d.stats.missing;
            }
            list.innerHTML = "";
            if(d.data && d.data.length) {
                d.data.reverse().forEach(i => {
                    let div = document.createElement('div');
                    div.style.background = "#181818"; div.style.padding="10px"; div.style.marginBottom="10px"; div.style.borderLeft="3px solid var(--gold-mid)";
                    div.innerHTML = `<div><b>${i['–§–∞–º–∏–ª–∏—è –ò–º—è']}</b> <span style="float:right; font-size:0.8em">${i['–î–∞—Ç–∞']}</span></div>
                    <div style="margin:5px 0; color:#aaa;">${i['–í–∏–¥ —Ä–∞–±–æ—Ç']} (${i['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']})</div>
                    <button class="btn-small" onclick="upd('${i.ID}','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')" style="background:#2e7d32; color:#fff">V</button>
                    <button class="btn-small" onclick="upd('${i.ID}','–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')" style="background:#c62828; color:#fff">X</button>
                    <button class="btn-small" onclick="del('${i.ID}')" style="background:#333; color:#aaa">Del</button>`;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = "–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫";
            }
        });
    }

    function upd(id, st) { if(confirm(st+"?")) postData({action:'update', id:id, status:st}, loadReq); }
    function del(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) postData({action:'delete_row', id:id}, loadReq); }
    function postData(data, cb) {
        let p = new URLSearchParams();
        for(let k in data) p.append(k, data[k]);
        fetch(API, {method:'POST', body:p}).then(cb);
    }
    function dl(type) {
        let url = API + "?action=get_" + type;
        window.open(url, '_blank'); // –ü—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    }

    // --- –ö–ê–°–°–ò–† ---
    function changePayMonth(d) { payOffset += d; loadPayTable(); }
    function loadPayTable() {
        let t = document.getElementById('bigPayTable');
        t.innerHTML = "<tr><td style='padding:20px'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
        fetch(API + "?action=get_all_stats_month&offset=" + payOffset)
        .then(r=>r.json()).then(d => {
            if(d.result === "success") {
                payFullData = d;
                document.getElementById('payTableMonth').innerText = d.monthLabel;
                renderBigTable();
            }
        });
    }

    function renderBigTable() {
        let t = document.getElementById('bigPayTable');
        t.innerHTML = "";
        
        let h = "<tr><th>–§–ò–û</th>";
        for(let i=1; i<=payFullData.daysInMonth; i++) h += `<th>${i}</th>`;
        h += "<th>–î–Ω</th><th>–û–±</th></tr>";
        t.innerHTML = h;

        let names = Object.keys(payFullData.stats).sort();
        names.forEach(name => {
            let u = payFullData.stats[name];
            let row = document.createElement('tr');
            
            let tdName = document.createElement('td');
            tdName.className = "name-col";
            tdName.innerText = name;
            tdName.onclick = () => openPayControl(name, u.paidLimit);
            row.appendChild(tdName);

            for(let i=1; i<=payFullData.daysInMonth; i++) {
                let td = document.createElement('td');
                let val = ""; let bg = "";
                
                if(i <= u.paidLimit) { val="‚ÇΩ"; bg="bg-paid"; }
                else if(u.days[i]) { val=u.days[i]; bg="bg-ok"; }
                else if(payFullData.limitDay > 0 && i <= payFullData.limitDay) { bg="bg-miss"; }
                
                td.className = bg;
                td.innerText = val;
                row.appendChild(td);
            }
            
            row.innerHTML += `<td>${u.totalD}</td><td>${u.totalV}</td>`;
            t.appendChild(row);
        });
    }

    function openPayControl(name, limit) {
        payCurrentName = name;
        document.getElementById('payControlName').innerText = name;
        let s = document.getElementById('paySlider');
        s.max = payFullData.daysInMonth;
        s.value = limit;
        document.getElementById('sliderVal').innerText = limit;
        document.getElementById('payControl').style.display = 'block';
        document.getElementById('payControl').scrollIntoView({behavior:'smooth'});
    }

    function savePayment() {
        let lim = document.getElementById('paySlider').value;
        let m = document.getElementById('payTableMonth').innerText;
        let p = new URLSearchParams();
        p.append('action', 'save_payment');
        p.append('name', payCurrentName);
        p.append('month', m);
        p.append('limit', lim);
        
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(() => {
            document.getElementById('payControl').style.display = 'none';
            loadPayTable();
        });
    }

    // --- –®–¢–ê–¢ ---
    function openStaffModal() { document.getElementById('staffModal').style.display='flex'; loadStaff(); }
    function loadStaff() {
        let div = document.getElementById('staffList');
        div.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get_staff_list").then(r=>r.json()).then(d=>{
            div.innerHTML = "";
            d.staff.forEach(s => {
                let r = document.createElement('div');
                r.style.padding="10px"; r.style.borderBottom="1px solid #333";
                let isFired = (s.status === "Fired");
                r.innerHTML = `<span style="${isFired?'text-decoration:line-through; color:#777':''}">${s.name}</span>
                <button class="btn-small" onclick="${isFired?'restore':'fire'}Emp('${s.name}')" style="float:right; background:${isFired?'#2e7d32':'#c62828'}; color:#fff">${isFired?'–í–µ—Ä–Ω—É—Ç—å':'–£–≤–æ–ª–∏—Ç—å'}</button>`;
                div.appendChild(r);
            });
        });
    }
    function addEmployee() { let n=document.getElementById('newEmpName').value; if(n) postData({action:'add_employee', name:n}, ()=>{document.getElementById('newEmpName').value=''; loadStaff();}); }
    function fireEmp(n) { if(confirm("–£–≤–æ–ª–∏—Ç—å?")) postData({action:'fire_employee', name:n}, loadStaff); }
    function restoreEmp(n) { if(confirm("–í–µ—Ä–Ω—É—Ç—å?")) postData({action:'restore_employee', name:n}, loadStaff); }

</script>
</body>
</html>
