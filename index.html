<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --primary: #ff9900;
            --text: #ffffff;
            --border: #333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 15px;
            display: flex; justify-content: center; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 480px; margin-top: 20px;
        }
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .box {
            background: var(--card); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        h2 { text-align: center; color: var(--primary); margin-top: 0; text-transform: uppercase;}
        
        label { display: block; margin: 15px 0 5px; color: #aaa; font-size: 0.9em;}
        input, select {
            width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid var(--border);
            border-radius: 8px; color: #fff; font-size: 16px; outline: none; box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--primary); }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        .main-btn {
            width: 100%; padding: 15px; margin-top: 25px;
            background: var(--primary); color: #000; font-weight: bold; border: none;
            border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.2s;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* –†–∞–¥–∏–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .radio-group { display: flex; gap: 10px; margin-top: 5px; }
        .radio-label {
            flex: 1; padding: 12px; background: #2c2c2c; border: 1px solid var(--border);
            text-align: center; border-radius: 8px; cursor: pointer; color: #aaa; transition: 0.2s;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label {
            background: rgba(255, 153, 0, 0.2); border-color: var(--primary); color: var(--primary);
        }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        #adminView { display: none; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-title { font-size: 1.2em; font-weight: bold; color: #fff; }
        .btn-logout { background: #d32f2f; color: #fff; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        
        .admin-actions { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;}
        .btn-action { background: #333; color: #fff; border: 1px solid #555; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em;}
        .btn-action:hover { border-color: var(--primary); color: var(--primary); }

        .req-card { background: #252525; padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--primary); border-radius: 4px; }
        .req-info { font-size: 0.9em; color: #ccc; margin-bottom: 8px; }
        .req-btns { display: flex; gap: 10px; }
        .btn-yes, .btn-no { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-yes { background: #2e7d32; color: #fff; }
        .btn-no { background: #c62828; color: #fff; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #msg { text-align: center; margin-top: 15px; min-height: 20px; font-weight: bold;}
        .success { color: var(--primary); }
        .error { color: #ff5252; }
        
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.8em; color: #555; cursor: pointer; }
        
        /* –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞ */
        #authModal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index: 100;
        }
    </style>
</head>
<body>

<div class="container">
    
    <div id="userView" class="box">
        <h2>WestProm</h2>
        <form id="wForm">
            <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select id="nameSelect" name="name" required><option>–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
            
            <label>–ü–ò–ù-–∫–æ–¥</label>
            <input type="tel" name="pin" required placeholder="****" maxlength="6" style="text-align:center; letter-spacing: 5px;">

            <label>–ö–æ–ª-–≤–æ –ª—é–¥–µ–π</label>
            <select name="count" id="countSelect">
                <option value="0.5">0.5 (–ü–æ–ª–¥–Ω—è)</option>
                <script>for(let i=1; i<=20; i++) document.write(`<option value="${i}">${i}</option>`);</script>
            </select>

            <label>–¢–∏–ø —Ä–∞–±–æ—Ç</label>
            <div class="radio-group">
                <input type="radio" id="t1" name="type" value="–î–Ω–µ–≤–∫–∞" checked>
                <label for="t1" class="radio-label">‚è± –î–Ω–µ–≤–∫–∞</label>
                <input type="radio" id="t2" name="type" value="–û–±—ä–µ–º">
                <label for="t2" class="radio-label">üì¶ –û–±—ä–µ–º</label>
            </div>

            <button id="sBtn" class="main-btn">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </form>
        <div id="msg"></div>
        <div class="admin-link" onclick="openAuth()">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
    </div>

    <div id="adminView" class="box">
        <div class="admin-header">
            <div class="admin-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <button class="btn-logout" onclick="logoutAdmin()">–í—ã–π—Ç–∏ ‚úï</button>
        </div>
        
        <div class="admin-actions">
            <button class="btn-action" onclick="loadRequests()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn-action" onclick="downloadFile('excel')">üíæ Excel</button>
            <button class="btn-action" onclick="downloadFile('pdf')">üìÑ PDF</button>
        </div>

        <div id="reqList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

</div>

<div id="authModal">
    <div class="box" style="width:300px; text-align:center;">
        <h3>–ü–∞—Ä–æ–ª—å</h3>
        <input type="password" id="adminPass" style="margin-bottom:15px; text-align:center;">
        <button class="main-btn" onclick="loginAdmin()" style="padding:10px; margin-top:5px;">–í–æ–π—Ç–∏</button>
        <div style="margin-top:15px; color:#888; cursor:pointer;" onclick="document.getElementById('authModal').style.display='none'">–û—Ç–º–µ–Ω–∞</div>
    </div>
</div>

<script>
    // =======================================================
    // üëá –í–°–¢–ê–í–¨–¢–ï –°–í–ï–ñ–£–Æ –°–°–´–õ–ö–£ /EXEC –ó–î–ï–°–¨ üëá
    const API = "https://script.google.com/macros/s/AKfycbw_4uDPcfT94aqHLRWHHIpNCw0kuJJb6SOof5Zo1OwS5COMTzzjZbb1UTWuFC4gkco5cg/exec";
    // =======================================================

    const userView = document.getElementById('userView');
    const adminView = document.getElementById('adminView');
    const nameSelect = document.getElementById('nameSelect');
    const msg = document.getElementById('msg');
    
    // –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê –ü–†–ò –ó–ê–ü–£–°–ö–ï
    if(localStorage.getItem('wp_admin') === 'true') {
        showAdminPanel();
    } else {
        loadEmployees();
    }

    function loadEmployees() {
        fetch(API + "?action=get_employees")
        .then(r => r.json())
        .then(d => {
            nameSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>';
            if(d.data) d.data.forEach(n => {
                let opt = document.createElement('option');
                opt.value = n; opt.innerText = n;
                if(localStorage.getItem('wp_name') === n) opt.selected = true;
                nameSelect.appendChild(opt);
            });
        });
    }

    // –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–ï–¢–ê
    document.getElementById('wForm').onsubmit = e => {
        e.preventDefault();
        const btn = document.getElementById('sBtn');
        btn.disabled = true; btn.innerText = "‚è≥..."; msg.innerText = "";
        
        localStorage.setItem('wp_name', nameSelect.value); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–º—è

        const fd = new FormData(document.getElementById('wForm'));
        const p = new URLSearchParams();
        p.append('action', 'create');
        for(const [k,v] of fd.entries()) p.append(k,v);

        fetch(API, {method:'POST', body:p})
        .then(r => r.json())
        .then(d => {
            btn.disabled = false; btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨";
            if(d.result === "success") {
                msg.className = "success"; msg.innerText = "‚úÖ –ü—Ä–∏–Ω—è—Ç–æ! ID: " + d.id.slice(0,4);
                setTimeout(() => { document.getElementById('wForm').reset(); nameSelect.value = localStorage.getItem('wp_name'); msg.innerText="";}, 2000);
            } else {
                msg.className = "error"; msg.innerText = d.message;
            }
        }).catch(() => { btn.disabled = false; btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨"; msg.className="error"; msg.innerText="–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"; });
    };

    // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù–ê ---
    function openAuth() { document.getElementById('authModal').style.display = 'flex'; }
    
    function loginAdmin() {
        if(document.getElementById('adminPass').value === "westprom123") {
            localStorage.setItem('wp_admin', 'true');
            document.getElementById('authModal').style.display = 'none';
            showAdminPanel();
        } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    }

    function logoutAdmin() {
        localStorage.removeItem('wp_admin');
        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–µ—Ä–Ω–µ—Ç –≤ —Ä–µ–∂–∏–º —é–∑–µ—Ä–∞
    }

    function showAdminPanel() {
        userView.style.display = 'none';
        adminView.style.display = 'block';
        loadRequests();
    }

    function loadRequests() {
        const list = document.getElementById('reqList');
        list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get").then(r => r.json()).then(d => {
            list.innerHTML = "";
            if(!d.data || d.data.length === 0) { list.innerHTML = "<div style='text-align:center;color:#666'>–ü—É—Å—Ç–æ</div>"; return; }
            
            d.data.reverse().forEach(item => {
                let div = document.createElement('div');
                div.className = 'req-card';
                div.innerHTML = `
                    <div class="req-info"><b>${item['–§–∞–º–∏–ª–∏—è –ò–º—è']}</b> (${item['–î–∞—Ç–∞']})</div>
                    <div style="margin-bottom:10px">–õ—é–¥–µ–π: <b style="color:#fff">${item['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']}</b> | ${item['–í–∏–¥ —Ä–∞–±–æ—Ç']}</div>
                    <div class="req-btns">
                        <button class="btn-yes" onclick="setStatus('${item.ID}','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn-no" onclick="setStatus('${item.ID}','–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')">–û—Ç–∫–∞–∑–∞—Ç—å</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    function setStatus(id, st) {
        if(!confirm(st + "?")) return;
        const p = new URLSearchParams(); p.append('action','update'); p.append('id',id); p.append('status',st);
        fetch(API, {method:'POST', body:p}).then(() => loadRequests());
    }

    function downloadFile(type) {
        const action = type === 'excel' ? 'get_excel' : 'get_pdf';
        const btn = event.target; 
        const oldText = btn.innerText;
        btn.innerText = "‚è≥...";
        
        fetch(API + "?action=" + action)
        .then(r => r.json())
        .then(d => {
            btn.innerText = oldText;
            if(d.result === "success") window.open(d.url, '_blank');
            else alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞");
        });
    }
</script>

</body>
</html>
