<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm Premium</title>
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-bright: #fff3c5; --gold-mid: #d4af37; --gold-dark: #997b2f;
            --metallic-gold-gradient: linear-gradient(to bottom, var(--gold-bright) 0%, var(--gold-mid) 20%, var(--gold-dark) 50%, var(--gold-mid) 80%, var(--gold-bright) 100%);
        }
        body { font-family: 'Lato', sans-serif; background: #1a1a1a; color: #ccc; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .logo-container { margin-bottom: 25px; text-align: center; }
        h1.gold-sign { font-family: 'Cinzel', serif; font-weight: 900; font-size: 2.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; background: linear-gradient(to bottom, #fffde8 0%, #e3c472 20%, #d4af37 50%, #a0832a 51%, #d4af37 80%, #fffde8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.8)); }
        .subtitle-sign { font-family: 'Cinzel', serif; color: var(--gold-mid); font-size: 0.8rem; letter-spacing: 6px; text-transform: uppercase; margin-top: 5px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .box { background: #222; border: 2px solid; border-image: var(--metallic-gold-gradient) 1; box-shadow: 0 0 20px rgba(0,0,0,0.5); padding: 30px; border-radius: 2px; width: 100%; max-width: 440px; box-sizing: border-box; margin-bottom: 25px; position: relative; }
        label { color: var(--gold-mid); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; margin-top: 20px; }
        select, input { width: 100%; padding: 15px; background: #181818; border: 1px solid #333; border-bottom: 3px solid; border-image: var(--metallic-gold-gradient) 1; border-radius: 2px; color: var(--gold-bright); font-family: 'Lato', sans-serif; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
        select:focus, input:focus { background: #202020; box-shadow: inset 0 3px 10px rgba(0,0,0,0.9), 0 0 15px rgba(212, 175, 55, 0.2); }
        .radio-group { display: flex; gap: 2px; margin-top: 10px; background: #111; padding: 4px; border: 1px solid #333; border-radius: 4px; }
        .radio-lbl { flex: 1; padding: 14px; text-align: center; color: #777; cursor: pointer; transition: 0.3s; font-family: 'Cinzel', serif; font-weight: bold; font-size: 0.9em; text-transform: uppercase; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-lbl { background: var(--metallic-gold-gradient); color: #2a1a00; }
        
        .btn, .gold-btn { width: 100%; padding: 20px; margin-top: 20px; background: linear-gradient(to bottom, #ffeead 0%, #d4af37 20%, #a0832a 45%, #d4af37 55%, #ffeead 100%); border: 1px solid #a0832a; border-radius: 3px; font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px; letter-spacing: 2px; cursor: pointer; color: #3a2a00; text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn:active { transform: translateY(2px); }
        
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.75em; color: #666; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
        
        #toast { visibility: hidden; min-width: 250px; background: #111; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; margin-left: -125px; border: 1px solid var(--gold-mid); }
        #toast.show { visibility: visible; }

        /* –ê–¥–º–∏–Ω–∫–∞ –∏ –ö–∞—Å—Å–∞ */
        #adminPanel, #paymentPanel { display: none; background: #1a1a1a; border: 1px solid var(--gold-mid); padding: 30px; border-radius: 4px; width: 100%; max-width: 95%; box-sizing: border-box; margin-top: 20px; }
        .admin-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding-bottom: 15px;}
        .dashboard-stats { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .d-item { text-align: center; width: 32%; }
        .d-val { font-size: 1.4em; font-weight: bold; color: #fff; font-family: 'Cinzel'; }
        .d-lbl { font-size: 0.6em; color: #888; text-transform: uppercase; }
        .btn-small { padding: 8px 12px; font-size: 0.7em; background: var(--metallic-gold-gradient); color: #2a1a00; border: none; border-radius: 2px; cursor: pointer; font-weight: bold; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        #authModal, #qrModal, #statsModal, #staffModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.96); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .auth-box, .qr-box, .stats-box, .staff-box { background: #111; border: 2px solid var(--gold-mid); padding: 30px; width: 340px; text-align: center; max-height: 90vh; overflow-y: auto; }
        
        /* –ü–æ–∏—Å–∫ –∏ –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ */
        .search-box { position: relative; width: 100%; }
        #nDropdown, #payDropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #222; border: 1px solid var(--gold-mid);
            max-height: 250px; overflow-y: auto; z-index: 500;
            display: none;
        }
        .dd-item { padding: 15px; border-bottom: 1px solid #333; color: #ccc; cursor: pointer; text-align: left; }
        .dd-item:hover { background: #333; color: #fff; }

        /* –¢–∞–±–ª–∏—Ü–∞ –ö–∞—Å—Å–∏—Ä–∞ */
        .pay-table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #333; }
        .pay-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .pay-table th, .pay-table td { border: 1px solid #333; padding: 8px; text-align: center; font-size: 0.8em; color: #ccc; }
        .pay-table th { background: #000; color: var(--gold-mid); position: sticky; top: 0; z-index: 10; }
        .pay-table td.name-col { text-align: left; font-weight: bold; background: #111; position: sticky; left: 0; border-right: 2px solid var(--gold-mid); cursor: pointer; color: #fff; z-index: 5; }
        .pay-table td.name-col:hover { color: var(--gold-mid); }
        .bg-ok { background: #2e7d32; color: #fff; }
        .bg-miss { background: #c62828; color: #fff; }
        .bg-paid { background: #e91e63; color: #fff; font-weight: bold; }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #333; color: #555; border-radius: 4px; font-size: 0.8em; position: relative; }
        .cal-day.work { background: #2e7d32; color: #fff; }
        .cal-day.miss { background: #c62828; color: #fff; }
        .cal-day.paid { background: #e91e63; color: #fff; }
        .cal-day.paid::after { content: '‚ÇΩ'; position: absolute; bottom: 1px; right: 2px; font-size: 9px; font-weight: bold; color: #fff; }

        /* –°–ª–∞–π–¥–µ—Ä */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 25px; width: 25px; border-radius: 50%; background: var(--gold-mid); cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(212,175,55,0.8); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 5px; background: #333; border-radius: 2px; }

        #errorDisplay { display: none; background: #c62828; color: #fff; padding: 10px; margin-bottom: 20px; border-radius: 4px; text-align: center; width: 100%; }
        #payControl { display: none; margin-top: 20px; padding: 20px; background: #1a1a1a; border: 1px solid var(--gold-mid); }
    </style>
</head>
<body>

<div class="logo-container">
    <h1 class="gold-sign">WestProm</h1>
    <div class="subtitle-sign">Global Industries</div>
</div>

<div id="errorDisplay"></div>

<div class="box" id="mainBox">
    <form id="wForm">
        <label>üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <div class="search-box">
            <input type="text" id="nSearch" name="name" required placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..." autocomplete="off">
            <div id="nDropdown"></div>
        </div>

        <label>üîí –ü–ò–ù-–∫–æ–¥</label>
        <input type="tel" id="nPin" name="pin" required placeholder="–í–∞—à PIN" maxlength="6" style="text-align:center; letter-spacing:5px; font-size: 1.2em;" oninput="saveUser()">

        <label>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <select name="count" id="countSelect" onchange="saveUser()">
            <option value="1" selected>1 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="0.5">0.5 (–ü–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è)</option>
            <script>for(let i=2;i<=20;i++)document.write(`<option value="${i}">${i}</option>`)</script>
        </select>

        <label>‚öôÔ∏è –¢–∏–ø —Ä–∞–±–æ—Ç</label>
        <div class="radio-group">
            <input type="radio" id="t1" name="type" value="–î–Ω–µ–≤–∫–∞" checked><label for="t1" class="radio-lbl">–î–Ω–µ–≤–∫–∞</label>
            <input type="radio" id="t2" name="type" value="–û–±—ä–µ–º"><label for="t2" class="radio-lbl">–û–±—ä–µ–º</label>
        </div>

        <button class="btn" id="sBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button type="button" class="gold-btn" onclick="showMyStats()">üèÜ –ú–æ—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </form>
    <div class="admin-link" onclick="openAuth()">–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
</div>

<div id="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

<div id="authModal">
    <div class="auth-box">
        <h3 style="color:var(--gold-mid)">–í–•–û–î</h3>
        <input type="password" id="pass" style="text-align:center; margin-bottom:20px;" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="login()" style="margin-top:0;">–í–æ–π—Ç–∏</button>
        <div style="margin-top:20px; cursor:pointer; color:#777;" onclick="closeModal('authModal')">–û—Ç–º–µ–Ω–∞</div>
    </div>
</div>

<div id="statsModal">
    <div class="stats-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-small" onclick="changeMonth(-1)"><</button>
            <h3 id="calMonth" style="margin:0; color:#fff;">...</h3>
            <button class="btn-small" onclick="changeMonth(1)">></button>
        </div>
        <div style="display:flex; justify-content:space-around; margin:15px 0; border-bottom:1px solid #333; padding-bottom:10px;">
             <div><span style="font-size:1.5em; font-weight:bold; color:#fff;" id="my-dnevka">-</span><br><span style="font-size:0.7em; color:#777;">–î–ù–ï–í–ö–ê</span></div>
             <div><span style="font-size:1.5em; font-weight:bold; color:#fff;" id="my-volume">-</span><br><span style="font-size:0.7em; color:#777;">–û–ë–™–ï–ú</span></div>
        </div>
        <div id="calendarView"></div>
        <div style="font-size:0.7em; color:#666; margin-top:10px;">* –†–æ–∑–æ–≤—ã–π = –û–ø–ª–∞—á–µ–Ω–æ</div>
        <button class="btn-small" onclick="closeModal('statsModal')" style="margin-top:20px; width:100%;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="adminPanel">
    <div class="admin-head"><span style="color:var(--gold-mid); font-weight:bold;">ADMIN</span> <button class="btn-small" onclick="logout()">–í—ã—Ö–æ–¥</button></div>
    <div class="dashboard-stats">
        <div class="d-item"><span class="d-val" id="st-dnevka">-</span><span class="d-lbl">–î–Ω–µ–≤–∫–∞</span></div>
        <div class="d-item"><span class="d-val" id="st-volume">-</span><span class="d-lbl">–û–±—ä–µ–º</span></div>
        <div class="d-item"><span class="d-val" id="st-miss" style="color:#e57373">-</span><span class="d-lbl">–î–æ–ª–≥</span></div>
    </div>
    <button class="gold-btn" onclick="openStaffModal()">üë• –®–¢–ê–¢</button>
    <div style="display:flex; gap:5px; justify-content:center; margin-top:10px;">
        <button class="btn-small" onclick="loadReq()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-small" onclick="dl('excel')">Excel</button>
    </div>
    <div id="list" style="margin-top:20px; text-align:center; color:#555;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div id="paymentPanel">
    <div class="admin-head"><span style="color:#e91e63; font-weight:bold;">–§–ò–ù–ê–ù–°–´</span> <button class="btn-small" onclick="logout()">–í—ã—Ö–æ–¥</button></div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button class="btn-small" onclick="changePayMonth(-1)"><</button>
        <span id="payTableMonth" style="color:#fff; font-weight:bold;">...</span>
        <button class="btn-small" onclick="changePayMonth(1)">></button>
    </div>
    <div class="pay-table-container">
        <table class="pay-table" id="bigPayTable"></table>
    </div>
    
    <div id="payControl">
        <h3 style="color:var(--gold-mid); margin-top:0;" id="payControlName">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
        <div style="margin: 20px 0; text-align:center;">
            <label style="margin-top:0">–û–ø–ª–∞—Ç–∏—Ç—å –¥–æ: <span id="sliderVal" style="color:#fff; font-size:1.2em;">0</span></label>
            <input type="range" id="paySlider" min="0" max="31" value="0" oninput="document.getElementById('sliderVal').innerText=this.value">
        </div>
        <button class="gold-btn" onclick="savePayment()" style="background: linear-gradient(to bottom, #f48fb1, #e91e63); border:none; color:#fff;">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-small" onclick="document.getElementById('payControl').style.display='none'" style="margin-top:10px; width:100%; background:#333;">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="staffModal">
    <div class="staff-box">
        <h3>–®–¢–ê–¢</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
             <input id="newEmpName" placeholder="–§–ò–û" style="padding:10px;">
             <button class="btn-small" onclick="addEmployee()" style="background:#2e7d32; color:#fff;">+</button>
        </div>
        <div id="staffList" style="text-align:left;">...</div>
        <button class="btn-small" onclick="closeModal('staffModal')" style="margin-top:20px; width:100%;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    // =======================================================
    // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ –ù–ò–ñ–ï –í–ù–£–¢–†–¨ –ö–ê–í–´–ß–ï–ö ‚ö†Ô∏è
    const API = "https://script.google.com/macros/s/AKfycbyL0fdqnjIUw6JKSR0JNkPc3912TnGhRCih6IkDEg5dhTQIT0r_uQfmczCE91jd6q7n0A/exec";
    // =======================================================

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let allEmployees = [];
    let currentOffset = 0; // –î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —é–∑–µ—Ä–∞
    let payOffset = 0;     // –î–ª—è –∫–∞—Å—Å—ã
    let payCurrentName = "";
    let payFullData = null;
    let statsData = null;

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    window.onerror = function(msg, url, line) {
        document.getElementById('errorDisplay').style.display = 'block';
        document.getElementById('errorDisplay').innerText = "–û—à–∏–±–∫–∞: " + msg + " (–°—Ç—Ä–æ–∫–∞ " + line + ")";
        return false;
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener("DOMContentLoaded", function() {
        if (API.includes("–í–°–¢–ê–í–¨–¢–ï")) {
            alert("–í—ã –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ API –≤ –∫–æ–¥!");
            return;
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        try {
            if(localStorage.getItem('wp_pin')) document.getElementById('nPin').value = localStorage.getItem('wp_pin');
            if(localStorage.getItem('wp_count')) document.getElementById('countSelect').value = localStorage.getItem('wp_count');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω-—Å–µ—Å—Å–∏–∏
            let auth = localStorage.getItem('wp_admin_auth');
            if(auth === 'main') { 
                document.getElementById('adminPanel').style.display = 'block'; 
                document.getElementById('mainBox').style.display = 'none';
                loadReq(); 
            } else if(auth === 'payment') { 
                document.getElementById('paymentPanel').style.display = 'block'; 
                document.getElementById('mainBox').style.display = 'none';
                loadPayTable(); 
            } else {
                // –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω, –≥—Ä—É–∑–∏–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                loadEmpSelect();
            }
        } catch(e) { console.error(e); }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞
        setupSearch();
    });

    // --- –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê –°–û–¢–†–£–î–ù–ò–ö–û–í ---
    function setupSearch() {
        const ns = document.getElementById('nSearch');
        const dd = document.getElementById('nDropdown');
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –∏–ª–∏ –∫–ª–∏–∫–µ
        ns.addEventListener('focus', () => { renderDropdown(allEmployees); dd.style.display='block'; });
        ns.addEventListener('click', () => { renderDropdown(allEmployees); dd.style.display='block'; });
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        ns.addEventListener('input', function() {
            let val = this.value.toLowerCase();
            let filtered = allEmployees.filter(n => n.toLowerCase().includes(val));
            renderDropdown(filtered);
            dd.style.display = 'block';
        });

        // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if(!ns.contains(e.target) && !dd.contains(e.target)) dd.style.display='none';
        });
    }

    function renderDropdown(list) {
        const dd = document.getElementById('nDropdown');
        const ns = document.getElementById('nSearch');
        dd.innerHTML = "";
        
        if (list.length === 0) {
            dd.innerHTML = "<div class='dd-item' style='color:#777; cursor:default'>–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</div>";
            return;
        }

        list.forEach(name => {
            let div = document.createElement('div');
            div.className = "dd-item";
            div.innerText = name;
            div.onclick = () => {
                ns.value = name;
                dd.style.display = 'none';
                saveUser();
            };
            dd.appendChild(div);
        });
    }

    function loadEmpSelect() {
        const ns = document.getElementById('nSearch');
        ns.placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get_employees")
            .then(r => r.json())
            .then(d => {
                if (d.data) {
                    allEmployees = d.data;
                    renderDropdown(allEmployees);
                    let saved = localStorage.getItem('wp_user');
                    if (saved) ns.value = saved;
                    else ns.placeholder = "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞...";
                }
            })
            .catch(e => {
                ns.placeholder = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏";
                showToast("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º", true);
            });
    }

    function saveUser() {
        localStorage.setItem('wp_user', document.getElementById('nSearch').value);
        localStorage.setItem('wp_pin', document.getElementById('nPin').value);
        localStorage.setItem('wp_count', document.getElementById('countSelect').value);
    }

    // --- –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–ï–¢–ê ---
    document.getElementById('wForm').onsubmit = function(e) {
        e.preventDefault();
        let btn = document.getElementById('sBtn');
        btn.disabled = true; btn.innerText = "‚è≥...";

        let fd = new FormData(document.getElementById('wForm'));
        let params = new URLSearchParams();
        params.append('action', 'create');
        for (let pair of fd.entries()) { params.append(pair[0], pair[1]); }

        fetch(API, { method: 'POST', body: params })
            .then(r => r.json())
            .then(d => {
                btn.disabled = false; btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨";
                if (d.result === "success") {
                    showToast("‚úÖ –£–°–ü–ï–®–ù–û");
                    setTimeout(() => {
                        document.getElementById('wForm').reset();
                        document.getElementById('nSearch').value = localStorage.getItem('wp_user');
                        document.getElementById('nPin').value = localStorage.getItem('wp_pin');
                        document.getElementById('countSelect').value = "1";
                    }, 1000);
                } else {
                    showToast("‚õî " + d.message, true);
                }
            })
            .catch(() => {
                btn.disabled = false; btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨";
                showToast("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", true);
            });
    };

    // --- –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
    function showMyStats() {
        let n = document.getElementById('nSearch').value;
        let p = document.getElementById('nPin').value;
        if (!n || !p) { showToast("–í–≤–µ–¥–∏—Ç–µ –ò–º—è –∏ PIN", true); return; }
        
        document.getElementById('statsModal').style.display = 'flex';
        currentOffset = 0;
        loadUserStats();
    }

    function changeMonth(delta) {
        currentOffset += delta;
        loadUserStats();
    }

    function loadUserStats() {
        let n = document.getElementById('nSearch').value;
        let p = document.getElementById('nPin').value;
        document.getElementById('calendarView').innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        
        fetch(API + `?action=get_user_stats&name=${encodeURIComponent(n)}&pin=${p}&offset=${currentOffset}`)
            .then(r => r.json())
            .then(d => {
                if (d.result === "success") {
                    statsData = d.stats;
                    renderUserCalendar();
                } else {
                    document.getElementById('calendarView').innerHTML = d.message;
                }
            });
    }

    function renderUserCalendar() {
        if (!statsData) return;
        document.getElementById('calMonth').innerText = statsData.label;
        document.getElementById('my-dnevka').innerText = statsData.dnevka;
        document.getElementById('my-volume').innerText = statsData.volume;

        let html = '<div class="calendar-grid">';
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(day => html += `<div style="text-align:center; font-size:0.7em; color:var(--gold-mid);">${day}</div>`);

        for (let i = 1; i <= statsData.daysInMonth; i++) {
            let cls = "cal-day";
            if (statsData.workDays.includes(i)) cls += " work";
            else if (statsData.limitDay > 0 && i <= statsData.limitDay) cls += " miss";
            
            if (i <= statsData.paidLimit) cls += " paid";
            html += `<div class="${cls}">${i}</div>`;
        }
        html += '</div>';
        document.getElementById('calendarView').innerHTML = html;
    }

    // --- –ö–ê–°–°–ò–† ---
    function changePayMonth(d) { payOffset += d; loadPayTable(); }
    
    function loadPayTable() {
        let t = document.getElementById('bigPayTable');
        t.innerHTML = "<tr><td style='padding:20px'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
        fetch(API + "?action=get_all_stats_month&offset=" + payOffset)
            .then(r => r.json())
            .then(d => {
                if (d.result === "success") {
                    payFullData = d;
                    document.getElementById('payTableMonth').innerText = d.monthLabel;
                    renderBigTable();
                } else {
                    t.innerHTML = "<tr><td>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>";
                }
            });
    }

    function renderBigTable() {
        if(!payFullData) return;
        let t = document.getElementById('bigPayTable');
        t.innerHTML = "";
        
        // –®–∞–ø–∫–∞
        let head = "<tr><th class='name-col'>–§–ò–û</th>";
        for(let i=1; i<=payFullData.daysInMonth; i++) head += `<th>${i}</th>`;
        head += "<th>–î–Ω</th><th>–û–±</th></tr>";
        t.innerHTML = head;

        let names = Object.keys(payFullData.stats).sort();
        
        names.forEach(name => {
            let u = payFullData.stats[name];
            let row = document.createElement('tr');
            
            let tdName = document.createElement('td');
            tdName.className = "name-col";
            tdName.innerText = name;
            tdName.onclick = () => openPayControl(name, u.paidLimit);
            row.appendChild(tdName);

            for(let i=1; i<=payFullData.daysInMonth; i++) {
                let td = document.createElement('td');
                let val = ""; let bg = "";
                
                if (i <= u.paidLimit) { val="‚ÇΩ"; bg="bg-paid"; }
                else if (u.days[i]) { val=u.days[i]; bg="bg-ok"; }
                else if (payFullData.limitDay > 0 && i <= payFullData.limitDay) { bg="bg-miss"; }
                
                td.className = bg;
                td.innerText = val;
                row.appendChild(td);
            }
            // –ò—Ç–æ–≥–∏
            row.innerHTML += `<td>${u.totalD}</td><td>${u.totalV}</td>`;
            t.appendChild(row);
        });
    }

    function openPayControl(name, limit) {
        payCurrentName = name;
        document.getElementById('payControlName').innerText = name;
        let s = document.getElementById('paySlider');
        s.max = payFullData.daysInMonth;
        s.value = limit;
        document.getElementById('sliderVal').innerText = limit;
        
        let pc = document.getElementById('payControl');
        pc.style.display = 'block';
        pc.scrollIntoView({behavior:'smooth'});
    }

    function savePayment() {
        let limit = document.getElementById('paySlider').value;
        let month = document.getElementById('payTableMonth').innerText;
        
        let params = new URLSearchParams();
        params.append('action', 'save_payment');
        params.append('name', payCurrentName);
        params.append('month', month);
        params.append('limit', limit);
        
        fetch(API, {method:'POST', body:params})
            .then(r=>r.json())
            .then(() => {
                document.getElementById('payControl').style.display = 'none';
                loadPayTable();
            });
    }

    // --- –ê–î–ú–ò–ù–ö–ê ---
    function loadReq() {
        let list = document.getElementById('list');
        list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get").then(r=>r.json()).then(d => {
            if(d.stats) {
                document.getElementById('st-dnevka').innerText = d.stats.dnevka;
                document.getElementById('st-volume').innerText = d.stats.volume;
                document.getElementById('st-miss').innerText = d.stats.missing;
            }
            list.innerHTML = "";
            if(d.data && d.data.length > 0) {
                d.data.reverse().forEach(i => {
                    let div = document.createElement('div');
                    div.style.background = "#222"; 
                    div.style.padding = "10px"; 
                    div.style.marginBottom = "10px"; 
                    div.style.borderLeft = "3px solid var(--gold-mid)";
                    div.innerHTML = `
                        <div style="font-weight:bold; color:#fff">${i['–§–∞–º–∏–ª–∏—è –ò–º—è']} <span style="float:right; font-size:0.8em; color:#777">${i['–î–∞—Ç–∞']}</span></div>
                        <div style="margin:5px 0; color:#aaa">${i['–í–∏–¥ —Ä–∞–±–æ—Ç']} (${i['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']})</div>
                        <button class="btn-small" style="background:#2e7d32; color:#fff" onclick="upd('${i.ID}','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn-small" style="background:#c62828; color:#fff" onclick="upd('${i.ID}','–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')">–û—Ç–∫–ª</button>
                        <button class="btn-small" style="background:#444; color:#ccc" onclick="del('${i.ID}')">–£–¥–∞–ª–∏—Ç—å</button>
                    `;
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = "–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫";
            }
        });
    }

    function upd(id, st) { if(confirm(st+"?")) sendAct({action:'update', id:id, status:st}, loadReq); }
    function del(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) sendAct({action:'delete_row', id:id}, loadReq); }
    function sendAct(data, cb) {
        let p = new URLSearchParams();
        for(let k in data) p.append(k, data[k]);
        fetch(API, {method:'POST', body:p}).then(cb);
    }
    function dl(type) { window.open(API + "?action=get_" + type, '_blank'); }

    // --- –®–¢–ê–¢ ---
    function openStaffModal() { document.getElementById('staffModal').style.display='flex'; loadStaff(); }
    function loadStaff() {
        let l = document.getElementById('staffList');
        l.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get_staff_list").then(r=>r.json()).then(d => {
            l.innerHTML = "";
            if(d.staff) {
                d.staff.forEach(s => {
                    let div = document.createElement('div');
                    div.style.padding = "10px";
                    div.style.borderBottom = "1px solid #333";
                    let isFired = (s.status === "Fired");
                    div.innerHTML = `<span style="color:${isFired?'#777':'#ccc'}; text-decoration:${isFired?'line-through':''};">${s.name}</span>
                    <button class="btn-small" style="float:right; background:${isFired?'#2e7d32':'#c62828'}; color:#fff" 
                    onclick="${isFired?'restore':'fire'}Emp('${s.name}')">${isFired?'–í–µ—Ä–Ω—É—Ç—å':'–£–≤–æ–ª–∏—Ç—å'}</button>`;
                    l.appendChild(div);
                });
            }
        });
    }
    function addEmployee() { let n=document.getElementById('newEmpName').value; if(n) sendAct({action:'add_employee', name:n}, ()=>{ document.getElementById('newEmpName').value=''; loadStaff(); }); }
    function fireEmp(n) { if(confirm("–£–≤–æ–ª–∏—Ç—å?")) sendAct({action:'fire_employee', name:n}, loadStaff); }
    function restoreEmp(n) { if(confirm("–í–µ—Ä–Ω—É—Ç—å?")) sendAct({action:'restore_employee', name:n}, loadStaff); }

    // --- –°–ò–°–¢–ï–ú–ù–´–ï ---
    function openAuth() { document.getElementById('authModal').style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function login() {
        let p = document.getElementById('pass').value;
        if(p === "westprom123") {
            localStorage.setItem('wp_admin_auth', 'main');
            location.reload();
        } else if(p === "money777") {
            localStorage.setItem('wp_admin_auth', 'payment');
            location.reload();
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        }
    }
    function logout() {
        if(confirm("–í—ã–π—Ç–∏?")) {
            localStorage.removeItem('wp_admin_auth');
            location.reload();
        }
    }
    function showToast(text, isErr) {
        let t = document.getElementById("toast");
        t.innerText = text;
        t.className = "show";
        t.style.borderColor = isErr ? "#c62828" : "#d4af37";
        setTimeout(() => t.className = "", 3000);
    }
</script>
</body>
</html>
