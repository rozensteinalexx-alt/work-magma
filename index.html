<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm –û—Ç—á–µ—Ç</title>
    <style>
        :root {
            --bg: #0f0a0a;
            --card: #1a1212;
            --accent: #ffae00; /* –ñ–µ–ª—Ç—ã–π –æ–≥–æ–Ω—å */
            --accent-dark: #d12222; /* –ö—Ä–∞—Å–Ω—ã–π –æ–≥–æ–Ω—å */
            --text: #ffebd1;
            --border: #3d2b2b;
        }
        body {
            font-family: Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            background: var(--card);
            width: 100%; max-width: 450px;
            padding: 30px; border-radius: 16px;
            border: 1px solid var(--border);
            border-top: 3px solid var(--accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h2 { text-align: center; color: var(--accent); margin-top: 0; text-transform: uppercase; letter-spacing: 2px;}
        label { display: block; margin-bottom: 8px; font-size: 0.9em; color: #aaa; margin-top: 15px;}
        
        select, input {
            width: 100%; padding: 15px;
            background: #241919; border: 2px solid var(--border);
            border-radius: 8px; color: #fff; font-size: 16px;
            box-sizing: border-box; outline: none; transition: 0.3s;
        }
        select:focus, input:focus { border-color: var(--accent); }
        
        /* –ö–Ω–æ–ø–∫–∞ */
        .main-btn {
            width: 100%; padding: 16px; margin-top: 25px;
            background: linear-gradient(45deg, var(--accent-dark), var(--accent));
            border: none; border-radius: 8px;
            color: #000; font-weight: bold; font-size: 18px; text-transform: uppercase;
            cursor: pointer; transition: 0.3s;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { background: #444; color: #888; cursor: not-allowed;}

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #msg { margin-top: 20px; text-align: center; font-weight: bold; min-height: 20px;}
        .success { color: var(--accent); border: 1px solid var(--accent); padding: 10px; border-radius: 8px;}
        .error { color: #ff5555; border: 1px solid #ff5555; padding: 10px; border-radius: 8px;}

        /* –†–∞–¥–∏–æ –∫–Ω–æ–ø–∫–∏ */
        .radio-group { display: flex; gap: 10px; }
        .radio-label {
            flex: 1; padding: 12px; background: #241919; border: 2px solid var(--border);
            text-align: center; border-radius: 8px; cursor: pointer; color: #888;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label {
            border-color: var(--accent); color: #fff; background: rgba(255, 174, 0, 0.1);
        }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.8em; color: #555; cursor: pointer;}
        #adminPanel { display: none; margin-top: 30px; border-top: 1px dashed #444; padding-top: 20px;}
        .card-item { background: #222; padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--accent); border-radius: 4px;}
        .btn-mini { padding: 5px 10px; font-size: 12px; cursor: pointer; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; margin-right: 5px;}
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #authModal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:999;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="userView">
        <h2>WestProm</h2>
        
        <form id="wForm">
            <label>–ö—Ç–æ —Å–¥–∞–µ—Ç –æ—Ç—á–µ—Ç?</label>
            <select id="nameSelect" name="name" required>
                <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</option>
            </select>

            <label>–ü–ò–ù-–∫–æ–¥ (–¥–ª—è –∑–∞—â–∏—Ç—ã)</label>
            <input type="tel" name="pin" required placeholder="****" maxlength="6" style="text-align:center; letter-spacing: 5px; font-size: 1.2em;">

            <label>–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ —Ä–∞–±–æ—Ç–∞–ª–æ?</label>
            <select name="count">
                <option value="0.5">0.5 (–ü–æ–ª–¥–Ω—è)</option>
                <script>
                    for(let i=1; i<=20; i++) document.write(`<option value="${i}">${i} —á–µ–ª.</option>`);
                </script>
            </select>

            <label>–¢–∏–ø —Ä–∞–±–æ—Ç</label>
            <div class="radio-group">
                <input type="radio" id="t1" name="type" value="–î–Ω–µ–≤–∫–∞" checked>
                <label for="t1" class="radio-label">‚è± –î–Ω–µ–≤–∫–∞</label>
                
                <input type="radio" id="t2" name="type" value="–û–±—ä–µ–º">
                <label for="t2" class="radio-label">üì¶ –û–±—ä–µ–º</label>
            </div>

            <button type="submit" id="sBtn" class="main-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
        </form>

        <div id="msg"></div>
        <div class="admin-link" onclick="openAuth()">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
    </div>

    <div id="adminPanel">
        <h3 style="color:#fff; text-align:center">–ó–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h3>
        <div style="text-align:center; margin-bottom:15px;">
            <button class="btn-mini" onclick="loadRequests()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn-mini" onclick="downloadExcel()">–°–∫–∞—á–∞—Ç—å Excel</button>
        </div>
        <div id="list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
</div>

<div id="authModal">
    <div style="background:var(--card); padding:30px; border-radius:10px; text-align:center; border:1px solid var(--accent);">
        <h3 style="color:var(--text); margin-top:0;">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞</h3>
        <input type="password" id="adminPass" style="margin-bottom:15px;">
        <button class="main-btn" onclick="checkPass()" style="padding:10px; margin-top:0;">–í–æ–π—Ç–∏</button>
        <div style="margin-top:10px; color:#888; cursor:pointer;" onclick="document.getElementById('authModal').style.display='none'">–û—Ç–º–µ–Ω–∞</div>
    </div>
</div>

<script>
    // ============================================================
    // üëá –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –ù–û–í–£–Æ –°–°–´–õ–ö–£ –ü–û–°–õ–ï –ü–£–ë–õ–ò–ö–ê–¶–ò–ò –°–ö–†–ò–ü–¢–ê üëá
    const API = "https://script.google.com/macros/s/AKfycbzNy1a8xjpJ3uPNZKp0rWH6ETMD2IFBLGZ_9tgHz_eFkX0UwM8Eium7aY4L0Hd3YFHqug/exec"; 
    // ============================================================

    const f = document.getElementById('wForm');
    const m = document.getElementById('msg');
    const btn = document.getElementById('sBtn');
    const nameSelect = document.getElementById('nameSelect');

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    window.onload = function() {
        if(API.includes("–í–°–¢–ê–í–¨–¢–ï")) {
            alert("–û—à–∏–±–∫–∞! –í—ã –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–∏ —Å—Å—ã–ª–∫—É API –≤ –∫–æ–¥ —Å–∞–π—Ç–∞.");
            return;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–º–µ–Ω–∏ –∏–∑ –ø–∞–º—è—Ç–∏
        const savedName = localStorage.getItem('wp_name');
        
        fetch(API + "?action=get_employees")
        .then(res => res.json())
        .then(data => {
            if(data.result === "success") {
                nameSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–±—è</option>';
                data.data.forEach(name => {
                    let opt = document.createElement('option');
                    opt.value = name;
                    opt.innerText = name;
                    if(savedName === name) opt.selected = true;
                    nameSelect.appendChild(opt);
                });
            } else {
                nameSelect.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }).catch(err => {
            console.error(err);
            nameSelect.innerHTML = '<option>–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π</option>';
        });

        // –ï—Å–ª–∏ –∞–¥–º–∏–Ω —É–∂–µ –±—ã–ª –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
        if(localStorage.getItem('wp_admin') === 'true') {
            document.getElementById('userView').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadRequests();
        }
    };

    // –û–¢–ü–†–ê–í–ö–ê –§–û–†–ú–´
    f.onsubmit = function(e) {
        e.preventDefault();
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        btn.disabled = true;
        btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
        m.className = ""; m.innerText = "";

        const formData = new FormData(f);
        // –î–æ–±–∞–≤–ª—è–µ–º action –≤—Ä—É—á–Ω—É—é, —Ç–∞–∫ –∫–∞–∫ FormData –µ–≥–æ –Ω–µ –±–µ—Ä–µ—Ç –∏–∑ HTML –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        const params = new URLSearchParams();
        params.append('action', 'create');
        for(const [key, value] of formData.entries()) {
            params.append(key, value);
        }

        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–º—è
        localStorage.setItem('wp_name', nameSelect.value);

        fetch(API, {
            method: 'POST',
            body: params
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç";
            
            if (data.result === "success") {
                m.className = "success";
                m.innerHTML = "‚úÖ –û—Ç—á–µ—Ç –ø—Ä–∏–Ω—è—Ç!<br>ID: " + data.id.substring(0,5);
                f.reset();
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
                nameSelect.value = localStorage.getItem('wp_name');
            } else if (data.result === "duplicate") {
                m.className = "error";
                m.innerText = "‚ö†Ô∏è " + data.message;
            } else {
                m.className = "error";
                m.innerText = "‚õî –û—à–∏–±–∫–∞: " + data.message;
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç";
            m.className = "error";
            m.innerText = "‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ —Å—Å—ã–ª–∫—É API.";
            console.error('Error:', error);
        });
    };

    // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù–ê ---
    function openAuth() { document.getElementById('authModal').style.display = 'flex'; }
    
    function checkPass() {
        const p = document.getElementById('adminPass').value;
        if(p === "westprom123") { // –í–∞—à –ø–∞—Ä–æ–ª—å
            localStorage.setItem('wp_admin', 'true');
            location.reload();
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω–æ");
        }
    }

    function loadRequests() {
        const list = document.getElementById('list');
        list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        
        fetch(API + "?action=get")
        .then(r => r.json())
        .then(d => {
            if(!d.data || d.data.length === 0) {
                list.innerHTML = "<div style='text-align:center; color:#666'>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</div>";
                return;
            }
            let html = "";
            d.data.reverse().forEach(item => {
                html += `
                <div class="card-item">
                    <div style="font-size:0.8em; color:#888">${item['–î–∞—Ç–∞']}</div>
                    <div style="font-size:1.1em; color:#fff; font-weight:bold">${item['–§–∞–º–∏–ª–∏—è –ò–º—è']}</div>
                    <div style="margin:5px 0">–õ—é–¥–µ–π: <b style="color:var(--accent)">${item['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']}</b> ‚Ä¢ ${item['–í–∏–¥ —Ä–∞–±–æ—Ç']}</div>
                    <div>
                        <button class="btn-mini" style="border-color:#4caf50; color:#4caf50" onclick="setStatus('${item['ID']}', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="btn-mini" style="border-color:#f44336; color:#f44336" onclick="setStatus('${item['ID']}', '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')">‚ùå –û—Ç–∫–∞–∑–∞—Ç—å</button>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        });
    }

    function setStatus(id, status) {
        if(!confirm(status + "?")) return;
        const p = new URLSearchParams();
        p.append('action', 'update');
        p.append('id', id);
        p.append('status', status);
        
        fetch(API, {method:'POST', body:p})
        .then(r => r.json())
        .then(() => loadRequests());
    }

    function downloadExcel() {
        window.open(API + "?action=get_excel", '_blank');
    }
</script>

</body>
</html>
