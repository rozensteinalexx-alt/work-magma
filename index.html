<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm Premium</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/48/gold-bars.png">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-bright: #fff3c5; --gold-mid: #d4af37; --gold-dark: #997b2f;
            --metallic-gold-gradient: linear-gradient(to bottom, var(--gold-bright) 0%, var(--gold-mid) 20%, var(--gold-dark) 50%, var(--gold-mid) 80%, var(--gold-bright) 100%);
        }
        body { font-family: 'Lato', sans-serif; background: linear-gradient(rgba(15, 15, 15, 0.9), rgba(10, 10, 10, 0.95)), url('https://www.transparenttextures.com/patterns/dark-wall.png'), #1a1a1a; color: #ccc; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .logo-container { margin-bottom: 25px; text-align: center; }
        h1.gold-sign { font-family: 'Cinzel', serif; font-weight: 900; font-size: 2.5rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; background: linear-gradient(to bottom, #fffde8 0%, #e3c472 20%, #d4af37 50%, #a0832a 51%, #d4af37 80%, #fffde8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.8)); }
        .subtitle-sign { font-family: 'Cinzel', serif; color: var(--gold-mid); font-size: 0.8rem; letter-spacing: 6px; text-transform: uppercase; margin-top: 5px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        .box { background: linear-gradient(135deg, rgba(35,35,35,0.95), rgba(20,20,20,0.98)), url('https://www.transparenttextures.com/patterns/concrete-wall.png'); border: 2px solid; border-image: var(--metallic-gold-gradient) 1; box-shadow: 0 0 0 4px #121212, 0 25px 60px rgba(0,0,0,1), inset 0 0 40px rgba(0,0,0,0.8); padding: 30px; border-radius: 2px; width: 100%; max-width: 440px; box-sizing: border-box; margin-bottom: 25px; }
        label { color: var(--gold-mid); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; margin-top: 20px; text-shadow: 0 1px 2px rgba(0,0,0,1); display: flex; align-items: center; gap: 8px; }
        select, input { width: 100%; padding: 15px; background: #181818; border: 1px solid #333; border-bottom: 3px solid; border-image: var(--metallic-gold-gradient) 1; border-radius: 2px; color: var(--gold-bright); font-family: 'Lato', sans-serif; font-size: 16px; box-sizing: border-box; outline: none; box-shadow: inset 0 3px 10px rgba(0,0,0,0.8); transition: 0.3s; }
        select:focus, input:focus { background: #202020; box-shadow: inset 0 3px 10px rgba(0,0,0,0.9), 0 0 15px rgba(212, 175, 55, 0.2); }
        select option { background-color: #1a1a1a; color: var(--gold-bright); padding: 12px; }
        
        .password-container { position: relative; width: 100%; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2em; user-select: none; opacity: 0.7; transition: 0.2s; z-index: 10; }
        .password-toggle:hover { opacity: 1; text-shadow: 0 0 10px var(--gold-mid); }

        .btn, .gold-btn { width: 100%; padding: 20px; margin-top: 20px; background: linear-gradient(to bottom, #ffeead 0%, #d4af37 20%, #a0832a 45%, #d4af37 55%, #ffeead 100%); border: 1px solid #a0832a; border-top: 1px solid #ffeead; border-radius: 3px; font-family: 'Cinzel', serif; font-weight: 900; font-size: 18px; letter-spacing: 2px; cursor: pointer; color: #3a2a00; text-transform: uppercase; box-shadow: 0 8px 0 #4a3b0a, 0 15px 20px rgba(0,0,0,0.6), inset 0 2px 3px rgba(255,255,255,0.5); transition: all 0.2s ease; position: relative; top: 0; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
        .btn:hover, .gold-btn:hover { filter: brightness(1.15) contrast(1.1); box-shadow: 0 8px 0 #4a3b0a, 0 0 25px rgba(212, 175, 55, 0.6), inset 0 2px 3px rgba(255,255,255,0.8); transform: translateY(-1px); }
        .btn:active, .gold-btn:active { top: 8px; box-shadow: 0 0 0 #4a3b0a, inset 0 3px 8px rgba(0,0,0,0.6); transform: translateY(0); filter: brightness(0.95); }
        .btn:disabled { background: #333; border:1px solid #444; color: #666; box-shadow: none; top: 4px; text-shadow: none; filter: none; transform: none; cursor: not-allowed;}
        
        .admin-link { text-align: center; margin-top: 30px; font-size: 0.75em; color: #666; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        .admin-link:hover { color: var(--gold-mid); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        #msg { text-align: center; margin-top: 25px; font-weight: bold; min-height: 20px; font-size: 0.95em;}
        #toast { visibility: hidden; min-width: 250px; background: #111; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; margin-left: -125px; border: 1px solid var(--gold-mid); box-shadow: 0 5px 20px rgba(0,0,0,0.8); opacity: 0; transition: 0.5s; font-family: 'Cinzel'; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { border-color: #c62828; color: #ff8a80; }
        
        #adminPanel { display: none; background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid var(--gold-mid); box-shadow: 0 20px 50px rgba(0,0,0,0.9); padding: 30px; border-radius: 4px; width: 100%; max-width: 440px; box-sizing: border-box; margin-top: 20px; }
        .admin-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(212, 175, 55, 0.2); padding-bottom: 15px;}
        .admin-title { font-family: 'Cinzel'; color: var(--gold-mid); font-weight: bold; font-size: 1.1em; letter-spacing: 1px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .dashboard-stats { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .d-item { text-align: center; width: 48%; cursor: pointer; }
        .d-val { font-size: 1.4em; font-weight: bold; color: #fff; display: block; font-family: 'Cinzel'; }
        .d-lbl { font-size: 0.6em; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        .btn-small { padding: 12px 10px; font-size: 0.7em; background: var(--metallic-gold-gradient); color: #2a1a00; border: 1px solid #8a6e18; border-radius: 3px; cursor: pointer; text-transform: uppercase; box-shadow: 0 3px 0 #4a3b0a, 0 5px 10px rgba(0,0,0,0.3); font-family: 'Lato', sans-serif; font-weight: 900; transition: 0.2s; position: relative; top:0; width: 100%; }
        .btn-small:hover { filter: brightness(1.2); box-shadow: 0 3px 0 #4a3b0a, 0 0 10px rgba(255, 255, 255, 0.4); }
        .btn-small:active { top: 3px; box-shadow: 0 0 0 #4a3b0a; filter: brightness(1.0); }
        .btn-small.logout { background: #222; color: #999; border: 1px solid #333; box-shadow: 0 3px 0 #111; width: auto; padding: 12px 18px;}
        .btn-small.logout:hover { color: #fff; background: #333; }
        
        .req-card { background: #141414; padding: 18px; margin-bottom: 15px; border: 1px solid #333; border-left: 4px solid var(--gold-mid); border-radius: 4px; box-shadow: inset 0 0 20px rgba(0,0,0,0.7); }
        .btn-act { flex: 1; padding: 12px; border: none; border-radius: 3px; cursor: pointer; font-weight: 900; font-size: 0.75em; text-transform: uppercase; box-shadow: 0 3px 0 rgba(0,0,0,0.5); text-shadow: 0 1px 1px rgba(0,0,0,0.5); transition: 0.2s;}
        .btn-act:hover { filter: brightness(1.15); }
        .btn-yes { background: linear-gradient(to bottom, #2e7d32, #1b5e20); color: #fff; border: 1px solid #1b5e20; }
        .btn-no { background: linear-gradient(to bottom, #c62828, #b71c1c); color: #fff; border: 1px solid #b71c1c; }
        .btn-del { width: auto; flex: 0 0 40px; margin-left: 5px; background: #333; color: #666; border: 1px solid #444; font-size: 1.2em; padding: 0; display: flex; align-items: center; justify-content: center;}
        .btn-del:hover { color: #c62828; border-color: #c62828; background: #222;}
        
        #authModal, #qrModal, #statsModal, #staffModal, #manualModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.96); display: none; justify-content: center; align-items: center; z-index: 999; }
        .auth-box, .qr-box, .stats-box, .staff-box, .manual-box { background: linear-gradient(135deg, #222 0%, #111 100%); border: 2px solid var(--gold-mid); padding: 40px; width: 340px; text-align: center; border-radius: 4px; box-shadow: 0 0 60px rgba(212, 175, 55, 0.15); max-height: 90vh; overflow-y: auto; }
        .qr-img { width: 250px; height: 250px; border: 5px solid #fff; border-radius: 10px; margin-bottom: 20px; display:block; margin: 0 auto 20px auto; }
        
        .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-nav button { background: none; border: none; color: var(--gold-mid); font-size: 1.5em; cursor: pointer; transition: 0.2s; }
        .cal-nav button:hover { color: #fff; text-shadow: 0 0 10px var(--gold-mid); }
        .cal-title { color: #fff; font-weight: bold; font-family: 'Cinzel'; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8em; color: #555; border-radius: 4px; background: #1a1a1a; border: 1px solid #333; cursor: pointer; transition: 0.2s; position: relative;}
        .cal-head { color: var(--gold-mid); font-weight: bold; text-align: center; margin-bottom: 5px; font-size: 0.7em;}
        .cal-day:hover { background: #333; color: #fff; border-color: #555; }
        .cal-day.work { background: #2e7d32; color: #fff; border-color: #4caf50; box-shadow: 0 0 5px rgba(76, 175, 80, 0.4); }
        .cal-day.miss { background: #c62828; color: #fff; border-color: #f44336; }
        .cal-day.paid { background: #e91e63; color: #fff; border-color: #f48fb1; box-shadow: 0 0 8px rgba(233, 30, 99, 0.6); }
        .cal-day.paid::after { content: '‚ÇΩ'; position: absolute; bottom: 1px; right: 1px; font-size: 8px; color: #fff; }
        
        .staff-item { text-align: left; background: #181818; border-bottom: 1px solid #333; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .staff-name { color: #ccc; font-weight: bold; font-size: 0.9em; flex:1; text-align:left;}
        .staff-fired { color: #e57373; text-decoration: line-through; }
        .role-tag { font-size:0.7em; padding:2px 5px; border-radius:3px; margin-left:5px; vertical-align:middle;}
        .r-SuperAdmin { background: linear-gradient(45deg, #ffd700, #ff8c00); color:#000; }
        .r-Director { background: #7b1fa2; color:#fff; }
        .r-Foreman { background: #1976d2; color:#fff; }
        
        .search-box { position: relative; }
        #nSearch, #adminSearch { cursor: pointer; } 
        .custom-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #222; border: 1px solid #444; border-top: none;
            max-height: 250px; overflow-y: auto; z-index: 100;
            display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.8);
            border-bottom-left-radius: 4px; border-bottom-right-radius: 4px;
        }
        .dd-item { padding: 15px; border-bottom: 1px solid #333; color: #ccc; cursor: pointer; transition: 0.2s; }
        .dd-item:hover { background: #333; color: #fff; border-left: 3px solid var(--gold-mid); padding-left: 12px; }
        .dd-item.selected { background: var(--metallic-gold-gradient); color: #111; font-weight: bold; }
        
        .role-select { background: #333; color:#fff; border:1px solid #444; padding:5px; border-radius:3px; font-size:0.7em; margin-right:5px;}
        
        .date-picker-row { display:flex; gap:5px; margin-bottom:10px; justify-content:center; }
        .date-picker-row select, .date-picker-row input { padding:8px; font-size:0.8em; }
    </style>
</head>
<body>

<div class="logo-container">
    <h1 class="gold-sign">WestProm</h1>
    <div class="subtitle-sign">Global Industries</div>
</div>

<div class="box">
    <form id="wForm">
        <label>üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        
        <div class="search-box">
            <input type="text" id="nSearch" name="name" required placeholder="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞..." autocomplete="off">
            <div id="nDropdown" class="custom-dropdown"></div>
        </div>

        <label>üîí –ü–ò–ù-–∫–æ–¥</label>
        <div class="password-container">
            <input type="password" id="nPin" name="pin" required placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ PIN" maxlength="6" 
                   style="text-align:center; letter-spacing:5px; font-size: 1.2em; padding-right: 40px;" 
                   oninput="this.value = this.value.replace(/\D/g,''); saveUser()">
            <span class="password-toggle" onclick="togglePass('nPin', this)">üëÅÔ∏è</span>
        </div>
        
        <label>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–ß–µ–ª.)</label>
        <select name="count" id="countSelect" onchange="saveUser()">
            <option value="1" selected>1 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="0.5">0.5 (–ü–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è)</option>
        </select>
        
        <input type="hidden" name="type" value="–î–Ω–µ–≤–∫–∞">
        
        <button class="btn" id="sBtn" style="margin-top: 40px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="gold-btn" type="button" onclick="showMyStats()">
            üèÜ –ú–æ—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        </button>
        
    </form>
    <div id="msg"></div>
    <div class="admin-link" onclick="openAuth()">–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
    <div class="admin-link" style="font-size:0.6em; margin-top:10px;" onclick="testConn()">‚ö° –¢–ï–°–¢ –°–í–Ø–ó–ò</div>
</div>

<div id="toast">–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</div>

<div id="adminPanel">
    <div class="admin-head">
        <span class="admin-title">ADMIN CONTROL</span>
        <button class="btn-small logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
    
    <div class="date-picker-row">
        <select id="repMonth">
            <option value="0">–Ø–Ω–≤–∞—Ä—å</option>
            <option value="1">–§–µ–≤—Ä–∞–ª—å</option>
            <option value="2">–ú–∞—Ä—Ç</option>
            <option value="3">–ê–ø—Ä–µ–ª—å</option>
            <option value="4">–ú–∞–π</option>
            <option value="5">–ò—é–Ω—å</option>
            <option value="6">–ò—é–ª—å</option>
            <option value="7">–ê–≤–≥—É—Å—Ç</option>
            <option value="8">–°–µ–Ω—Ç—è–±—Ä—å</option>
            <option value="9">–û–∫—Ç—è–±—Ä—å</option>
            <option value="10">–ù–æ—è–±—Ä—å</option>
            <option value="11">–î–µ–∫–∞–±—Ä—å</option>
        </select>
        <input type="number" id="repYear" value="2026" style="width:70px;">
    </div>
    <div style="font-size:0.7em; color:#aaa; margin-bottom:5px;">‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ —Å–±—Ä–æ—Å–∏—Ç —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏:</div>
    <button class="gold-btn" onclick="generateReport()" style="margin-bottom:15px; font-size:0.8em; padding:10px;">üîÑ 1. –°–§–û–†–ú–ò–†–û–í–ê–¢–¨ / –û–ë–ù–û–í–ò–¢–¨</button>

    <div style="display:flex; gap:5px; justify-content:center; margin-bottom:15px;">
        <button class="btn-small" onclick="downloadReport('excel')">üíæ 2. –°–∫–∞—á–∞—Ç—å Excel</button>
        <button class="btn-small" onclick="downloadReport('pdf')">üìÑ 2. –°–∫–∞—á–∞—Ç—å PDF</button>
    </div>
    <div style="font-size:0.65em; color:#666; margin-bottom:15px;">
        * –ö–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å" –±–µ–∑–æ–ø–∞—Å–Ω—ã, –æ–Ω–∏ –Ω–µ –º–µ–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ.
    </div>

    <div class="dashboard-stats">
        <div class="d-item"><span class="d-val" id="st-dnevka">-</span><span class="d-lbl">–°–¥–∞–Ω–æ —Å–º–µ–Ω</span></div>
        <div class="d-item" onclick="showDebtors()"><span class="d-val" id="st-miss" style="color:#e57373">-</span><span class="d-lbl">–ù–µ —Å–¥–∞–ª–∏ üëÅÔ∏è</span></div>
    </div>
    
    <button class="gold-btn" onclick="openManualModal()" style="margin-bottom: 10px;">‚ûï –î–û–ë–ê–í–ò–¢–¨ –í–†–£–ß–ù–£–Æ</button>
    <button class="gold-btn" onclick="openStaffModal()" style="margin-bottom: 15px;">üë• –£–ü–†–ê–í–õ–ï–ù–ò–ï –®–¢–ê–¢–û–ú</button>
    
    <button class="gold-btn" onclick="showQR()" style="margin-top: 10px;">üì± –ü–û–ö–ê–ó–ê–¢–¨ QR-–ö–û–î</button>
    <div id="list" style="text-align:center; color:#666; font-size:0.9em; margin-top:20px;">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>
</div>

<div id="authModal">
    <div class="auth-box">
        <h3 style="font-family:'Cinzel'; margin-top:0; font-size: 1.6em; letter-spacing: 2px; background: var(--metallic-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ADMIN LOGIN</h3>
        
        <div class="search-box" style="margin-bottom: 20px;">
            <input type="text" id="adminSearch" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –ê–¥–º–∏–Ω–∞..." autocomplete="off">
            <div id="adminDropdown" class="custom-dropdown"></div>
        </div>

        <div class="password-container" style="margin-bottom:30px;">
            <input type="password" id="adminPin" 
                   style="text-align:center; font-size:1.4em; letter-spacing: 5px; padding-right: 40px;" 
                   placeholder="–ü–ò–ù" maxlength="6"
                   oninput="this.value = this.value.replace(/\D/g,'')">
            <span class="password-toggle" onclick="togglePass('adminPin', this)">üëÅÔ∏è</span>
        </div>
        
        <button class="btn" id="loginBtn" onclick="login()" style="margin-top:0; padding: 18px;">–í—Ö–æ–¥</button>
        <div style="margin-top:30px; color:#666; cursor:pointer; font-size:0.85em; text-transform:uppercase; letter-spacing: 1px;" onclick="document.getElementById('authModal').style.display='none'">–û–¢–ú–ï–ù–ê</div>
    </div>
</div>

<div id="manualModal">
    <div class="manual-box">
        <h3 style="color:var(--gold-mid); margin-top:0; font-family:'Cinzel';">–î–û–ë–ê–í–ò–¢–¨ –°–ú–ï–ù–£</h3>
        
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <select id="mName" style="margin-bottom:15px;"></select>
        
        <label>–î–∞—Ç–∞</label>
        <input type="date" id="mDate" style="color-scheme:dark; margin-bottom:15px;">
        
        <label>–ö–æ–ª-–≤–æ</label>
        <select id="mCount">
            <option value="1">1</option>
            <option value="0.5">0.5</option>
            <option value="2">2</option>
        </select>
        
        <button class="btn" onclick="saveManualShift()" style="margin-top:20px;">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <div style="margin-top:15px; color:#666; cursor:pointer;" onclick="document.getElementById('manualModal').style.display='none'">–û–¢–ú–ï–ù–ê</div>
    </div>
</div>

<div id="qrModal" style="display:none;">
    <div class="qr-box">
        <h3 style="color:var(--gold-mid); margin-top:0; font-family:'Cinzel'; margin-bottom:20px;">SCAN TO ENTER</h3>
        <img id="qrImage" class="qr-img" src="" alt="QR Code">
        <div style="color:#aaa; font-size:0.8em; margin-bottom:20px;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
        <button class="btn-small" onclick="document.getElementById('qrModal').style.display='none'" style="width: auto; padding: 10px 30px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="staffModal" style="display:none;">
    <div class="staff-box">
        <h3 style="color:var(--gold-mid); margin-top:0; font-family:'Cinzel';">–®–¢–ê–¢ –°–û–¢–†–£–î–ù–ò–ö–û–í</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
             <input id="newEmpName" placeholder="–§–ò–û –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" style="padding:10px; font-size:0.9em;">
             <button class="btn-small" onclick="addEmployee()" style="width:auto; background: #2e7d32; color:#fff;">+</button>
        </div>
        <div style="color:#666; font-size:0.65em; margin-bottom:10px; text-align:left;">
            üëë <b>–ì–ª–∞–≤–Ω—ã–π:</b> –í–∏–¥–µ–Ω, –í—Å–µ –ø—Ä–∞–≤–∞.<br>
            üëî <b>–î–∏—Ä–µ–∫—Ç–æ—Ä:</b> –°–∫—Ä—ã—Ç, –í—Å–µ –ø—Ä–∞–≤–∞.<br>
            üë∑ <b>–ü—Ä–æ—Ä–∞–±:</b> –í–∏–¥–µ–Ω, –í—Å–µ –ø—Ä–∞–≤–∞.<br>
            üî® <b>–†–∞–±–æ—á–∏–π:</b> –í–∏–¥–µ–Ω, –ù–µ—Ç –ø—Ä–∞–≤.
        </div>
        <div id="staffList" style="max-height: 300px; overflow-y: auto; text-align: left;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button class="btn-small" onclick="document.getElementById('staffModal').style.display='none'" style="margin-top:20px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="statsModal" style="display:none;">
    <div class="stats-box">
        <div class="cal-nav">
            <button onclick="changeMonth(-1)">&#9664;</button>
            <div class="cal-title" id="calMonth">...</div>
            <button onclick="changeMonth(1)">&#9654;</button>
        </div>
        <div class="dashboard-stats" style="margin-bottom:10px; border:none; padding:0; justify-content: center;">
             <div class="d-item" style="width:100%"><span class="d-val" id="my-dnevka">-</span><span class="d-lbl">–í—Å–µ–≥–æ –°–º–µ–Ω</span></div>
        </div>
        <div id="calendarView"></div>
        <div style="text-align:center; color:#555; font-size:0.7em; margin-top:10px;">* –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å "–û–ø–ª–∞—á–µ–Ω–æ"</div>
        <button class="btn-small" onclick="document.getElementById('statsModal').style.display='none'" style="margin-top:20px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    // üëáüëá –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ –ò–ó –®–ê–ì–ê 3 –ù–ò–ñ–ï üëáüëá
    const API = "https://script.google.com/macros/s/AKfycbx9X_LtUTnq2YxGPf5oihDpcGZ5qq36rbmpDOswgKzjxBWscxvWkIGpHH8U5fdpkmkNkA/exec";
    // üëÜüëÜ ----------------------- üëÜüëÜ

    const ns = document.getElementById('nSearch');
    const dd = document.getElementById('nDropdown');
    const adminS = document.getElementById('adminSearch');
    const adminDD = document.getElementById('adminDropdown');
    
    const pin = document.getElementById('nPin');
    const countSelect = document.getElementById('countSelect');
    let debtorsList = [];
    let currentOffset = 0; 
    let statsData = null; 
    let allEmployees = []; 
    let adminList = [];

    function togglePass(id, el) {
       var x = document.getElementById(id);
       if (x.type === "password") { x.type = "text"; el.innerText = "üêµ"; el.style.opacity="1"; }
       else { x.type = "password"; el.innerText = "üëÅÔ∏è"; el.style.opacity="0.7"; }
    }

    window.onload = () => {
        let now = new Date();
        document.getElementById('repMonth').value = now.getMonth();
        document.getElementById('repYear').value = now.getFullYear();

        for(let i=2; i<=20; i++){
            let opt = document.createElement('option'); opt.value = i; opt.innerText = i;
            countSelect.appendChild(opt);
        }

        loadEmpSelect();
        if(localStorage.getItem('wp_pin')) { pin.value = localStorage.getItem('wp_pin'); }
        if(localStorage.getItem('wp_count')) countSelect.value = localStorage.getItem('wp_count');
        
        if(localStorage.getItem('wp_admin_name')) { 
            document.getElementById('adminPanel').style.display = 'block'; loadReq();
        }
    };
    
    function testConn() {
        showToast("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏...", false);
        fetch(API+"?action=test_connection")
        .then(r => r.json())
        .then(d => {
             alert("‚úÖ –£—Å–ø–µ—Ö: " + d.message);
        })
        .catch(e => {
             alert("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É API. –û—à–∏–±–∫–∞: " + e);
        });
    }

    function loadEmpSelect() {
        ns.placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        const cachedData = localStorage.getItem('wp_cache_employees');
        const cachedTime = localStorage.getItem('wp_cache_time');
        const now = new Date().getTime();

        if (cachedData && cachedTime && (now - cachedTime < 3600000)) { 
            allEmployees = JSON.parse(cachedData);
            renderDropdown(ns, dd, allEmployees, (name) => { saveUser(); });
            let saved = localStorage.getItem('wp_user');
            if(saved) ns.value = saved;
            else ns.placeholder = "üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è...";
        }

        fetch(API+"?action=get_employees").then(r=>r.json()).then(d=>{
            if(d.data) {
                allEmployees = d.data;
                localStorage.setItem('wp_cache_employees', JSON.stringify(allEmployees));
                localStorage.setItem('wp_cache_time', now);
                renderDropdown(ns, dd, allEmployees, (name) => { saveUser(); });
                let saved = localStorage.getItem('wp_user');
                if(saved) ns.value = saved;
                else ns.placeholder = "üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è...";
            }
        });
    }

    function renderDropdown(input, drop, list, cb) {
        drop.innerHTML = "";
        if(list.length === 0) {
            drop.innerHTML = "<div class='dd-item' style='cursor:default; color:#777'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>";
            return;
        }
        list.forEach(name => {
            let div = document.createElement('div');
            div.className = "dd-item";
            if(name === input.value) div.className += " selected";
            div.innerText = name;
            div.onclick = () => {
                input.value = name;
                drop.style.display = 'none';
                if(cb) cb(name);
            };
            drop.appendChild(div);
        });
    }

    ns.addEventListener('input', function() { showFilter(this, dd, allEmployees, saveUser); });
    ns.addEventListener('focus', function() { renderDropdown(ns, dd, allEmployees, saveUser); dd.style.display='block'; });
    adminS.addEventListener('input', function() { showFilter(this, adminDD, adminList, null); });
    adminS.addEventListener('focus', function() { renderDropdown(adminS, adminDD, adminList, null); adminDD.style.display='block'; });

    function showFilter(inp, drop, list, cb) {
        let val = inp.value.toLowerCase();
        let filtered = list.filter(n => n.toLowerCase().includes(val));
        renderDropdown(inp, drop, filtered, cb);
        drop.style.display = 'block';
    }

    document.addEventListener('click', function(e) {
        if (!ns.contains(e.target) && !dd.contains(e.target)) dd.style.display = 'none';
        if (!adminS.contains(e.target) && !adminDD.contains(e.target)) adminDD.style.display = 'none';
    });

    function saveUser() { localStorage.setItem('wp_user', ns.value); localStorage.setItem('wp_pin', pin.value); localStorage.setItem('wp_count', countSelect.value); }

    function showMyStats() {
        var p = pin.value; var n = ns.value;
        if(!p || !n) { showToast("‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –∏ –≤–≤–µ–¥–∏—Ç–µ –ü–ò–ù", true); return; }
        document.getElementById('statsModal').style.display='flex';
        currentOffset = 0;
        loadStats();
    }
    
    function changeMonth(delta) { currentOffset += delta; loadStats(); }
    
    function loadStats() {
        var p = pin.value; var n = ns.value;
        document.getElementById('calendarView').innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API + "?action=get_user_stats&name=" + encodeURIComponent(n) + "&pin=" + p + "&offset=" + currentOffset)
        .then(r=>r.json()).then(d => {
             if(d.result === "success") { statsData = d.stats; renderCalendar(); } 
             else document.getElementById('calendarView').innerHTML = "–û—à–∏–±–∫–∞: " + d.message;
        });
    }
    
    function renderCalendar() {
        if(!statsData) return;
        document.getElementById('calMonth').innerText = statsData.label;
        document.getElementById('my-dnevka').innerText = statsData.dnevka;
        let calHtml = '<div class="calendar-grid">';
        let days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
        days.forEach(d => calHtml += `<div class="cal-head">${d}</div>`);
        
        for(let e=0; e<statsData.emptySlots; e++) {
            calHtml += `<div class="cal-day" style="opacity:0; pointer-events:none;"></div>`;
        }

        let paidKey = "paid_" + ns.value + "_" + statsData.label;
        let paidDays = JSON.parse(localStorage.getItem(paidKey) || "[]");
        for(let i=1; i<=statsData.daysInMonth; i++) {
             let cls = "cal-day";
             if(statsData.workDays.includes(i)) cls += " work";
             else if(statsData.limitDay > 0 && i <= statsData.limitDay) cls += " miss";
             if(paidDays.includes(i)) cls += " paid";
             calHtml += `<div class="${cls}" onclick="togglePay(${i})">${i}</div>`;
        }
        calHtml += '</div>';
        document.getElementById('calendarView').innerHTML = calHtml;
    }
    
    function togglePay(day) {
        if(!statsData) return;
        let paidKey = "paid_" + ns.value + "_" + statsData.label;
        let paidDays = JSON.parse(localStorage.getItem(paidKey) || "[]");
        if(paidDays.includes(day)) paidDays = paidDays.filter(d => d !== day); else paidDays.push(day);
        localStorage.setItem(paidKey, JSON.stringify(paidDays));
        renderCalendar();
    }

    document.getElementById('wForm').onsubmit = e => {
        e.preventDefault();
        let b = document.getElementById('sBtn'); b.disabled=true; b.innerText="–û—Ç–ø—Ä–∞–≤–∫–∞...";
        let fd = new FormData(document.getElementById('wForm'));
        let p = new URLSearchParams(); p.append('action','create');
        for(let [k,v] of fd) p.append(k,v);
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d=>{
            b.disabled=false; b.innerText="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç";
            if(d.result==="success"){
                showToast("‚úÖ –û–¢–ß–ï–¢ –û–¢–ü–†–ê–í–õ–ï–ù");
                setTimeout(()=>{ document.getElementById('wForm').reset(); ns.value=localStorage.getItem('wp_user'); pin.value=localStorage.getItem('wp_pin'); if(localStorage.getItem('wp_count')) countSelect.value = localStorage.getItem('wp_count'); else countSelect.value = "1"; }, 1000);
            } else showToast(d.message, true); 
        }).catch(()=>{ b.disabled=false; b.innerText="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç"; showToast("‚ùå –û–®–ò–ë–ö–ê –°–í–Ø–ó–ò", true); });
    };

    function showToast(text, isErr=false) { var t = document.getElementById("toast"); t.innerText = text; t.className = "show" + (isErr ? " error" : ""); setTimeout(()=>{ t.className = t.className.replace("show", ""); }, 3000); }

    function openAuth() { 
        document.getElementById('authModal').style.display = 'flex'; 
        document.getElementById('adminSearch').placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get_sys_admins").then(r=>r.json()).then(d=>{
             if(d.data) {
                 adminList = d.data;
                 document.getElementById('adminSearch').placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ –ê–¥–º–∏–Ω–∞...";
                 renderDropdown(adminS, adminDD, adminList, null);
             }
        });
    }
    
    function login() {
        let name = document.getElementById('adminSearch').value;
        let p = document.getElementById('adminPin').value;
        if(!name || !p) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –ü–ò–ù"); return; }
        let btn = document.getElementById('loginBtn');
        btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞..."; btn.disabled = true;
        let params = new URLSearchParams();
        params.append('action', 'login_admin');
        params.append('name', name);
        params.append('pin', p);
        fetch(API, {method:'POST', body:params}).then(r => r.json()).then(d => {
            btn.innerText = "–í—Ö–æ–¥"; btn.disabled = false;
            if(d.result === "success") {
                localStorage.setItem('wp_admin_name', name);
                localStorage.setItem('wp_admin_pin', p);
                document.getElementById('authModal').style.display='none';
                document.getElementById('adminPanel').style.display='block';
                loadReq();
            } else { alert(d.message); }
        }).catch(() => { btn.innerText = "–í—Ö–æ–¥"; btn.disabled = false; alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"); });
    }
    
    function logout() { if(confirm("–í—ã–π—Ç–∏?")) { localStorage.removeItem('wp_admin_name'); localStorage.removeItem('wp_admin_pin'); location.reload(); } }

    function getAdminParams() {
        let p = new URLSearchParams();
        p.append('auth_name', localStorage.getItem('wp_admin_name') || "");
        p.append('auth_pin', localStorage.getItem('wp_admin_pin') || "");
        return p;
    }

    function loadReq() {
        let l = document.getElementById('list'); l.innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞...";
        let auth = "&auth_name=" + encodeURIComponent(localStorage.getItem('wp_admin_name')) + 
                   "&auth_pin=" + encodeURIComponent(localStorage.getItem('wp_admin_pin'));
        fetch(API+"?action=get"+auth).then(r=>r.json()).then(d=>{
            if(d.stats) {
                document.getElementById('st-dnevka').innerText = d.stats.dnevka;
                document.getElementById('st-miss').innerText = d.stats.missing;
                debtorsList = d.stats.missingNames || [];
            }
            l.innerHTML="";
            if(!d.data || !d.data.length) { l.innerHTML="<div style='margin-top:15px; opacity:0.6'>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>"; return;}
            d.data.reverse().forEach(i=>{
                let div = document.createElement('div'); div.className='req-card';
                div.innerHTML=`
                <div><span style="font-size:0.8em;color:#666;float:right">${i['–î–∞—Ç–∞']}</span><b class="req-info">${i['–§–∞–º–∏–ª–∏—è –ò–º—è']}</b></div>
                <div style="font-size:0.9em;color:var(--gold-mid);margin-top:5px">–õ—é–¥–µ–π: <b style="color:#fff">${i['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']}</b></div>
                <div class="req-btns" style="display:flex; margin-top:10px;">
                    <button class="btn-act btn-yes" onclick="upd('${i.ID}','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">‚úÖ</button>
                    <button class="btn-act btn-no" onclick="upd('${i.ID}','–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')">‚ùå</button>
                    <button class="btn-act btn-del" onclick="del('${i.ID}')">üóëÔ∏è</button>
                </div>`;
                l.appendChild(div);
            });
        });
    }

    function upd(id, st) { 
        if(!confirm(st+"?")) return; 
        let p = getAdminParams(); p.append('action','update'); p.append('id',id); p.append('status',st); 
        fetch(API,{method:'POST', body:p}).then(()=>loadReq()); 
    }
    
    function del(id) { 
        if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return; 
        let p = getAdminParams(); p.append('action','delete_row'); p.append('id',id); 
        fetch(API,{method:'POST', body:p}).then(()=>loadReq()); 
    }
    
    function showDebtors() { if(debtorsList.length) alert("‚ö†Ô∏è –ù–ï –°–î–ê–õ–ò:\n\n"+debtorsList.join("\n")); else alert("–í—Å–µ —Å–¥–∞–ª–∏!"); }
    
    function dl(type) {
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É: —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ–º –ª–∏—Å—Ç (–º–µ—Å—è—Ü/–≥–æ–¥), –ø–æ—Ç–æ–º –∫–∞—á–∞–µ–º
        downloadReport(type);
    }
    
    function showQR() {
        var url = window.location.href; var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(url); document.getElementById('qrImage').src = qrUrl; document.getElementById('qrModal').style.display = 'flex';
    }

    function openStaffModal() { document.getElementById('staffModal').style.display = 'flex'; loadStaffList(); }
    
    function loadStaffList() {
        let sl = document.getElementById('staffList'); sl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        let auth = "&auth_name=" + encodeURIComponent(localStorage.getItem('wp_admin_name')) + 
                   "&auth_pin=" + encodeURIComponent(localStorage.getItem('wp_admin_pin'));
                   
        fetch(API + "?action=get_staff_list" + auth).then(r=>r.json()).then(d=>{
            if(d.result === "success") {
                sl.innerHTML = "";
                d.staff.forEach(s => {
                    let isFired = (s.status === "Fired");
                    let nameClass = isFired ? "staff-name staff-fired" : "staff-name";
                    let roleTag = "";
                    if(s.role === "SuperAdmin") roleTag = "<span class='role-tag r-SuperAdmin'>üëë –ì–ª–∞–≤–Ω—ã–π</span>";
                    else if(s.role === "Director") roleTag = "<span class='role-tag r-Director'>üëî –î–∏—Ä–µ–∫—Ç–æ—Ä</span>";
                    else if(s.role === "Foreman") roleTag = "<span class='role-tag r-Foreman'>üë∑ –ü—Ä–æ—Ä–∞–±</span>";

                    let btnHtml = "";
                    
                    if(isFired) {
                        btnHtml = `<button class="btn-small" onclick="restoreEmp('${s.name}')" style="width:auto; padding:5px 10px; background:#2e7d32;">–í–ï–†–ù–£–¢–¨</button>`;
                    } else {
                        let roles = { "Worker": "–†–∞–±–æ—á–∏–π", "Foreman": "–ü—Ä–æ—Ä–∞–±", "Director": "–î–∏—Ä–µ–∫—Ç–æ—Ä", "SuperAdmin": "–ì–ª–∞–≤–Ω—ã–π" };
                        let selectHtml = `<select class="role-select" onchange="changeRole('${s.name}', this.value)">`;
                        for(let k in roles) {
                            selectHtml += `<option value="${k}" ${s.role===k?'selected':''}>${roles[k]}</option>`;
                        }
                        selectHtml += `</select>`;

                        btnHtml = selectHtml + `<button class="btn-small" onclick="fireEmp('${s.name}')" style="width:auto; padding:5px 10px; background:#c62828;">X</button>`;
                    }
                    
                    let div = document.createElement('div');
                    div.className = "staff-item";
                    div.innerHTML = `<span class="${nameClass}">${s.name} ${roleTag}</span> <div style="display:flex; align-items:center;">${btnHtml}</div>`;
                    sl.appendChild(div);
                });
            } else sl.innerHTML = "–û—à–∏–±–∫–∞: " + d.message;
        });
    }
    
    function addEmployee() {
        let n = document.getElementById('newEmpName').value; if(!n) return;
        if(!confirm("–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: " + n + "?")) return;
        let p = getAdminParams(); p.append('action','add_employee'); p.append('name',n);
        fetch(API, {method:'POST', body:p}).then(() => { document.getElementById('newEmpName').value = ""; loadStaffList(); loadEmpSelect(); });
    }
    function fireEmp(name) { if(!confirm("–£–≤–æ–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ " + name + "?")) return; let p = getAdminParams(); p.append('action','fire_employee'); p.append('name',name); fetch(API, {method:'POST', body:p}).then(() => { loadStaffList(); loadEmpSelect(); }); }
    function restoreEmp(name) { if(!confirm("–í–µ—Ä–Ω—É—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ " + name + " –≤ —à—Ç–∞—Ç?")) return; let p = getAdminParams(); p.append('action','restore_employee'); p.append('name',name); fetch(API, {method:'POST', body:p}).then(() => { loadStaffList(); loadEmpSelect(); }); }
    
    function changeRole(name, role) {
        if(!confirm("–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å " + name + " –Ω–∞ " + role + "?")) { loadStaffList(); return; }
        let p = getAdminParams(); p.append('action','set_role'); p.append('name',name); p.append('role', role);
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d => {
             if(d.result !== "success") alert(d.message);
             loadStaffList(); loadEmpSelect();
        });
    }

    // --- –§–£–ù–ö–¶–ò–ò –†–£–ß–ù–û–ì–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
    function openManualModal() {
        document.getElementById('manualModal').style.display='flex';
        document.getElementById('mDate').valueAsDate = new Date(); 
        let sel = document.getElementById('mName');
        sel.innerHTML = "";
        
        let list = allEmployees.length ? allEmployees : []; 
        if(!list.length) {
             fetch(API+"?action=get_employees").then(r=>r.json()).then(d=>{
                 if(d.data) {
                     d.data.forEach(n => {
                         let opt = document.createElement('option'); opt.value=n; opt.innerText=n; sel.appendChild(opt);
                     });
                 }
             });
        } else {
             list.forEach(n => {
                 let opt = document.createElement('option'); opt.value=n; opt.innerText=n; sel.appendChild(opt);
             });
        }
    }

    function saveManualShift() {
        let name = document.getElementById('mName').value;
        let date = document.getElementById('mDate').value;
        let count = document.getElementById('mCount').value;
        
        if(!name || !date) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"); return; }
        
        let p = getAdminParams(); 
        p.append('action','admin_add_record');
        p.append('target_name', name);
        p.append('target_date', date);
        p.append('count', count);
        
        let btn = event.target; 
        btn.innerText = "‚è≥";
        
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d => {
             btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨";
             if(d.result === "success") {
                 alert("‚úÖ –°–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
                 document.getElementById('manualModal').style.display='none';
                 loadReq(); 
             } else {
                 alert("–û—à–∏–±–∫–∞: " + d.message);
             }
        });
    }

    // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø ---
    function generateReport() {
        let m = document.getElementById('repMonth').value;
        let y = document.getElementById('repYear').value;
        if(!confirm("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç/–æ–±–Ω–æ–≤–∏—Ç –ª–∏—Å—Ç –∑–∞ " + y + "/" + (parseInt(m)+1) + ".\n–†—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –±—É–¥—É—Ç –°–¢–ï–†–¢–´! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) return;
        
        let p = getAdminParams();
        p.append('action', 'generate_report');
        p.append('month', m);
        p.append('year', y);
        
        let btn = event.target;
        btn.innerText = "‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...";
        btn.disabled = true;
        
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d => {
             btn.innerText = "üîÑ 1. –°–§–û–†–ú–ò–†–û–í–ê–¢–¨ / –û–ë–ù–û–í–ò–¢–¨";
             btn.disabled = false;
             if(d.result === "success") {
                 alert("‚úÖ –¢–∞–±–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω (–õ–∏—Å—Ç: " + d.sheetName + ").\n–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –ø—Ä–∞–≤–∫–∏ –≤ Google –¢–∞–±–ª–∏—Ü–µ.");
             } else {
                 alert("–û—à–∏–±–∫–∞: " + d.message);
             }
        });
    }

    // --- –°–ö–ê–ß–ò–í–ê–ù–ò–ï ---
    function downloadReport(type) {
        let m = document.getElementById('repMonth').value;
        let y = document.getElementById('repYear').value;
        
        let btn = event.target;
        let oldText = btn.innerText;
        btn.innerText = "‚è≥";
        btn.disabled = true;

        let p = getAdminParams();
        p.append('action', 'download_report');
        p.append('month', m);
        p.append('year', y);
        p.append('type', type);

        fetch(API, {method:'POST', body:p}).then(r => r.json()).then(d => {
            btn.innerText = oldText;
            btn.disabled = false;
            
            if(d.result === "success" && d.file) {
                const link = document.createElement('a');
                link.href = "data:" + d.mime + ";base64," + d.file;
                link.download = d.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("–û—à–∏–±–∫–∞: " + (d.message || "–õ–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å."));
            }
        }).catch(e => { btn.innerText = oldText; btn.disabled = false; alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); });
    }
</script>

</body>
</html>
