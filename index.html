<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WestProm</title>
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold-bright: #fff3c5; --gold-mid: #d4af37; --gold-dark: #997b2f;
            --grad: linear-gradient(to bottom, var(--gold-bright) 0%, var(--gold-mid) 20%, var(--gold-dark) 50%, var(--gold-mid) 80%, var(--gold-bright) 100%);
        }
        body { font-family: 'Lato', sans-serif; background: #121212; color: #ccc; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .logo-container { text-align: center; margin-bottom: 25px; }
        h1.gold-sign { font-family: 'Cinzel'; font-weight: 900; font-size: 2.2rem; margin: 0; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle-sign { font-family: 'Cinzel'; color: var(--gold-mid); font-size: 0.7rem; letter-spacing: 4px; font-weight: 700; }

        .box { background: #1e1e1e; border: 1px solid var(--gold-mid); box-shadow: 0 0 20px rgba(212, 175, 55, 0.1); padding: 25px; border-radius: 4px; width: 100%; max-width: 400px; box-sizing: border-box; margin-bottom: 20px; }
        
        label { color: var(--gold-mid); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; display: block; margin-top: 15px; }
        input, select { width: 100%; padding: 12px; background: #121212; border: 1px solid #333; border-bottom: 2px solid var(--gold-mid); color: #fff; font-size: 16px; outline: none; box-sizing: border-box; transition: 0.3s; }
        input:focus { background: #222; }

        /* –ö–ù–û–ü–ö–ò (Premium) */
        .btn, .gold-btn, .btn-small { background: var(--grad); border: none; border-radius: 2px; font-family: 'Cinzel'; font-weight: 900; cursor: pointer; color: #222; text-transform: uppercase; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn, .gold-btn { width: 100%; padding: 18px; margin-top: 25px; font-size: 16px; }
        .btn:hover, .gold-btn:hover, .btn-small:hover { filter: brightness(1.15); transform: scale(1.02); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .btn:active { transform: scale(0.98); }
        .btn-small { padding: 8px 15px; font-size: 0.7em; font-family: 'Lato', sans-serif; }
        
        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –î–Ω–µ–≤–∫–∞/–û–±—ä–µ–º (–í–µ—Ä–Ω—É–ª–∏ —Å—Ç–∞—Ä—ã–π –¥–∏–∑–∞–π–Ω) */
        .radio-wrapper { display:flex; gap:0; margin-top:5px; border:1px solid var(--gold-mid); border-radius:2px; overflow:hidden; }
        .radio-opt { flex:1; padding:12px; text-align:center; cursor:pointer; font-weight:bold; transition:0.3s; font-size:0.9em; background:#121212; color:#555; }
        .radio-opt.active { background: var(--grad); color:#111; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }

        /* –ü–ê–ù–ï–õ–ò */
        #adminPanel, #paymentPanel { display: none; background: #1a1a1a; border: 1px solid var(--gold-mid); padding: 20px; width: 100%; max-width: 95%; box-sizing: border-box; margin-top: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .admin-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .dashboard-stats { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .d-item { text-align: center; width: 32%; }
        .d-val { font-size: 1.3em; font-weight: bold; color: #fff; font-family: 'Cinzel'; }
        .d-lbl { font-size: 0.6em; color: #888; text-transform: uppercase; }

        /* –ü–û–ò–°–ö */
        .search-box { position: relative; }
        #nDropdown { position: absolute; top: 100%; left: 0; right: 0; background: #222; border: 1px solid var(--gold-mid); max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .dd-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .dd-item:hover { background: var(--gold-mid); color: #000; font-weight: bold; }

        /* –¢–ê–ë–õ–ò–¶–ê –ö–ê–°–°–ò–†–ê */
        .pay-table-container { overflow-x: auto; margin-top: 15px; border: 1px solid #333; }
        .pay-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .pay-table th, .pay-table td { border: 1px solid #333; padding: 6px; text-align: center; font-size: 0.75em; color: #ccc; }
        .pay-table th { background: #000; color: var(--gold-mid); position: sticky; top: 0; z-index: 10; font-family: 'Cinzel'; }
        .pay-table td.name-col { text-align: left; font-weight: bold; background: #181818; position: sticky; left: 0; border-right: 2px solid var(--gold-mid); cursor: pointer; color: #fff; z-index: 5; min-width: 120px;}
        .pay-table td.name-col:hover { color: var(--gold-mid); background: #222; }
        
        /* –¶–≤–µ—Ç–∞ —è—á–µ–µ–∫ (–û–ë–ù–û–í–õ–ï–ù–û) */
        .bg-ok { background: #2e7d32; color: #fff; } /* –ó–µ–ª–µ–Ω—ã–π */
        .bg-miss { background: #c62828; color: #fff; font-weight: bold; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .bg-paid { background: #e91e63; color: #fff; font-weight: bold; position: relative; } /* –†–æ–∑–æ–≤—ã–π */
        .bg-paid::after { content: '‚ÇΩ'; position: absolute; bottom: 1px; right: 2px; font-size: 8px; color: #fff; }

        /* –°–õ–ê–ô–î–ï–† */
        #payControl { display: none; background: #222; padding: 20px; border: 1px solid var(--gold-mid); position: fixed; bottom: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 2000; border-top-left-radius: 10px; border-top-right-radius: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        input[type=range] { -webkit-appearance: none; background: transparent; margin: 20px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 25px; width: 25px; border-radius: 50%; background: var(--gold-mid); cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(212,175,55,0.8); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 5px; background: #444; border-radius: 2px; }

        /* –ú–û–î–ê–õ–ö–ò */
        #authModal, #statsModal, #staffModal, #qrModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: #111; border: 1px solid var(--gold-mid); padding: 30px; width: 320px; text-align: center; max-height: 90vh; overflow-y: auto; border-radius: 4px; box-shadow: 0 0 30px rgba(212,175,55,0.2); }

        #toast { visibility: hidden; min-width: 250px; background: #222; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 10000; left: 50%; bottom: 30px; margin-left: -125px; border: 1px solid var(--gold-mid); }
        #toast.show { visibility: visible; }
        
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #333; font-size: 0.8em; position: relative; color: #555; }
        .cal-day.paid { background: #e91e63; color: #fff; }
        .cal-day.paid::after { content: '‚ÇΩ'; position: absolute; bottom: 1px; right: 2px; font-size: 8px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="logo-container">
    <h1 class="gold-sign">WestProm</h1>
    <div class="subtitle-sign">Global Industries</div>
</div>

<div class="box" id="mainBox">
    <form id="wForm">
        <label>üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <div class="search-box">
            <input type="text" id="nSearch" name="name" required placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..." autocomplete="off">
            <div id="nDropdown"></div>
        </div>
        
        <label>üîí –ü–ò–ù-–∫–æ–¥</label>
        <input type="tel" id="nPin" name="pin" required placeholder="PIN" maxlength="6" style="text-align:center; letter-spacing:5px; font-size: 1.2em;" oninput="saveUser()">
        
        <label>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <select name="count" id="countSelect" onchange="saveUser()">
            <option value="1" selected>1 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
            <option value="0.5">0.5 (–ü–æ–ª–æ–≤–∏–Ω–∞ –¥–Ω—è)</option>
            <script>for(let i=2;i<=20;i++)document.write(`<option value="${i}">${i}</option>`)</script>
        </select>
        
        <label>‚öôÔ∏è –¢–∏–ø —Ä–∞–±–æ—Ç</label>
        <div class="radio-wrapper">
            <div class="radio-opt active" id="optDnevka" onclick="setWorkType('–î–Ω–µ–≤–∫–∞')">–î–ù–ï–í–ö–ê</div>
            <div class="radio-opt" id="optVolume" onclick="setWorkType('–û–±—ä–µ–º')">–û–ë–™–ï–ú</div>
        </div>
        <input type="hidden" id="workType" name="type" value="–î–Ω–µ–≤–∫–∞">
        
        <button class="btn" id="sBtn">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        <button type="button" class="gold-btn" onclick="showMyStats()" style="margin-top:15px; background: transparent; border: 1px solid var(--gold-mid); color:var(--gold-mid);">üèÜ –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê</button>
    </form>
    <div style="text-align:center; margin-top:20px; font-size:0.7em; color:#666; cursor:pointer;" onclick="openAuth()">–ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê</div>
</div>

<div id="toast"></div>

<div id="adminPanel">
    <div class="admin-head"><span style="color:var(--gold-mid); font-weight:bold;">ADMIN</span> <button class="btn-small" style="background:#333;color:#ccc" onclick="logout()">–í–´–•–û–î</button></div>
    <div class="dashboard-stats">
        <div class="d-item"><span class="d-val" id="st-dnevka">-</span><br><span class="d-lbl">–î–ù–ï–í–ö–ê</span></div>
        <div class="d-item"><span class="d-val" id="st-volume">-</span><br><span class="d-lbl">–û–ë–™–ï–ú</span></div>
        <div class="d-item" onclick="showDebtors()"><span class="d-val" id="st-miss" style="color:#e57373">-</span><br><span class="d-lbl">–î–û–õ–ì</span></div>
    </div>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn-small" onclick="openStaffModal()" style="flex:1">üë• –®–¢–ê–¢</button>
        <button class="btn-small" onclick="dl('pdf')" style="width:70px">PDF</button>
        <button class="btn-small" onclick="dl('excel')" style="width:70px">XLS</button>
    </div>
    
    <div style="text-align:center; margin-bottom:10px;"><button class="btn-small" style="background:#333;color:#ccc" onclick="loadReq()">–û–ë–ù–û–í–ò–¢–¨ –°–ü–ò–°–û–ö</button></div>
    <div id="list" style="color:#666; font-size:0.8em; text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div id="paymentPanel">
    <div class="admin-head"><span style="color:#e91e63; font-weight:bold;">–§–ò–ù–ê–ù–°–´</span> <button class="btn-small" style="background:#333;color:#ccc" onclick="logout()">–í–´–•–û–î</button></div>
    
    <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:15px;">
        <button class="btn-small" onclick="changePayMonth(-1)"><</button>
        <span id="payTableMonth" style="color:#fff; font-weight:bold; font-family:'Cinzel'">...</span>
        <button class="btn-small" onclick="changePayMonth(1)">></button>
    </div>

    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
        <button class="btn-small" onclick="dl('pdf')">–°–ö–ê–ß–ê–¢–¨ PDF</button>
    </div>

    <div class="pay-table-container">
        <table class="pay-table" id="bigPayTable"></table>
    </div>
</div>

<div id="payControl">
    <h3 style="color:var(--gold-mid); margin:0 0 20px 0; text-align:center;" id="payControlName">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
    <div style="text-align:center;">
        <label style="margin:0">–û–ø–ª–∞—Ç–∏—Ç—å –¥–æ: <span id="sliderVal" style="color:#fff; font-size:1.5em; font-weight:bold;">0</span></label>
        <input type="range" id="paySlider" min="0" max="31" value="0" oninput="document.getElementById('sliderVal').innerText=this.value">
    </div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-small" onclick="savePayment(false)" style="flex:1;">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-small" onclick="savePayment(true)" style="flex:1; background: #e91e63; color:#fff;">‚úàÔ∏è –í TG</button>
    </div>
    <button class="btn-small" onclick="document.getElementById('payControl').style.display='none'" style="margin-top:10px; width:100%; background:transparent; border:none; color:#666;">–û–¢–ú–ï–ù–ê</button>
</div>

<div id="authModal"><div class="modal-box"><h3>–í–•–û–î</h3><input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å" style="text-align:center"><button class="btn" onclick="login()">–í–û–ô–¢–ò</button><br><br><span onclick="closeM('authModal')" style="color:#666;cursor:pointer">–ó–∞–∫—Ä—ã—Ç—å</span></div></div>
<div id="staffModal"><div class="modal-box"><h3>–®–¢–ê–¢</h3><input id="newEmpName" placeholder="–§–ò–û" style="margin-bottom:10px;"><button class="btn-small" onclick="addEmployee()">–î–û–ë–ê–í–ò–¢–¨</button><div id="staffList" style="text-align:left; margin-top:15px;"></div><br><span onclick="closeM('staffModal')" style="color:#666;cursor:pointer">–ó–∞–∫—Ä—ã—Ç—å</span></div></div>
<div id="statsModal"><div class="modal-box">
    <div style="display:flex; justify-content:space-between;"><button class="btn-small" onclick="changeMonth(-1)"><</button><span id="calMonth">...</span><button class="btn-small" onclick="changeMonth(1)">></button></div>
    <div id="calendarView"></div>
    <br><span onclick="closeM('statsModal')" style="color:#666;cursor:pointer">–ó–∞–∫—Ä—ã—Ç—å</span>
</div></div>

<script>
    // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ –ù–ò–ñ–ï ‚ö†Ô∏è
    const API = "https://script.google.com/macros/s/AKfycbxgwzj8XcvWe_Bi1_zwJq5umIIrXxCZoQvw2Bq-CIUTBIJ44DNUwAwZSmSxfsAozo5d2g/exec";
    
    let allEmployees = [], currentOffset = 0, payOffset = 0, payCurrentName = "", payFullData = null, statsData = null;

    function init() {
        if(API.includes("–í–°–¢–ê–í–¨–¢–ï")) return alert("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É API –≤ –∫–æ–¥!");
        loadEmpSelect();
        if(localStorage.getItem('wp_pin')) document.getElementById('nPin').value = localStorage.getItem('wp_pin');
        let auth = localStorage.getItem('wp_admin_auth');
        if(auth === 'main') { document.getElementById('adminPanel').style.display='block'; document.getElementById('mainBox').style.display='none'; loadReq(); }
        else if(auth === 'payment') { document.getElementById('paymentPanel').style.display='block'; document.getElementById('mainBox').style.display='none'; loadPayTable(); }
    }
    window.onload = init;

    // --- –û–ë–©–ò–ï ---
    function setWorkType(type) {
        document.getElementById('workType').value = type;
        document.getElementById('optDnevka').className = type==='–î–Ω–µ–≤–∫–∞'?'radio-opt active':'radio-opt';
        document.getElementById('optVolume').className = type==='–û–±—ä–µ–º'?'radio-opt active':'radio-opt';
    }
    function renderDropdown(list) {
        let dd = document.getElementById('nDropdown'); dd.innerHTML="";
        if(list.length===0) dd.innerHTML="<div class='dd-item'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>";
        list.forEach(n => { let d=document.createElement('div'); d.className='dd-item'; d.innerText=n; d.onclick=()=>{document.getElementById('nSearch').value=n; dd.style.display='none'; saveUser();}; dd.appendChild(d); });
    }
    document.getElementById('nSearch').addEventListener('input', function(){ renderDropdown(allEmployees.filter(n=>n.toLowerCase().includes(this.value.toLowerCase()))); document.getElementById('nDropdown').style.display='block'; });
    document.getElementById('nSearch').addEventListener('focus', function(){ renderDropdown(allEmployees); document.getElementById('nDropdown').style.display='block'; });
    document.onclick = (e) => { if(!e.target.closest('.search-box')) document.getElementById('nDropdown').style.display='none'; };

    function loadEmpSelect() { fetch(API+"?action=get_employees").then(r=>r.json()).then(d=>{ allEmployees=d.data||[]; if(localStorage.getItem('wp_user')) document.getElementById('nSearch').value=localStorage.getItem('wp_user'); }); }
    function saveUser() { localStorage.setItem('wp_user', document.getElementById('nSearch').value); localStorage.setItem('wp_pin', document.getElementById('nPin').value); }

    // --- –û–¢–ü–†–ê–í–ö–ê ---
    document.getElementById('wForm').onsubmit = (e) => {
        e.preventDefault();
        let btn = document.getElementById('sBtn'); btn.innerText="–û–¢–ü–†–ê–í–ö–ê..."; btn.disabled=true;
        let p = new URLSearchParams(new FormData(document.getElementById('wForm'))); p.append('action','create');
        fetch(API, {method:'POST', body:p}).then(r=>r.json()).then(d=>{
            btn.innerText="–û–¢–ü–†–ê–í–ò–¢–¨"; btn.disabled=false;
            if(d.result==="success") showToast("‚úÖ –û–¢–ü–†–ê–í–õ–ï–ù–û"); else showToast("‚õî "+d.message);
        });
    };

    // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –Æ–ó–ï–†–ê ---
    function showMyStats() { if(!document.getElementById('nPin').value) return showToast("–í–≤–µ–¥–∏—Ç–µ –ü–ò–ù!"); document.getElementById('statsModal').style.display='flex'; loadStats(); }
    function changeMonth(d) { currentOffset+=d; loadStats(); }
    function loadStats() {
        document.getElementById('calendarView').innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞...";
        let p = new URLSearchParams(); p.append('action','get_user_stats'); p.append('name',document.getElementById('nSearch').value); p.append('pin',document.getElementById('nPin').value); p.append('offset',currentOffset);
        fetch(API+"?"+p.toString()).then(r=>r.json()).then(d=>{
            if(d.result==="success") {
                statsData=d.stats; document.getElementById('calMonth').innerText=statsData.label;
                let h="<div class='calendar-grid'>";
                for(let i=1; i<=statsData.daysInMonth; i++) {
                    let c="cal-day"; 
                    if(i<=statsData.paidLimit) c+=" paid"; // –†–æ–∑–æ–≤—ã–π
                    else if(statsData.workDays.includes(i)) c+=" work"; // –ó–µ–ª–µ–Ω—ã–π
                    else if(statsData.limitDay>0 && i<=statsData.limitDay) c+=" miss"; // –ö—Ä–∞—Å–Ω—ã–π
                    h+=`<div class="${c}">${(c.includes('miss') && !c.includes('paid')) ? 'X' : i}</div>`;
                }
                document.getElementById('calendarView').innerHTML=h+"</div>";
            } else document.getElementById('calendarView').innerText=d.message;
        });
    }

    // --- –ö–ê–°–°–ê ---
    function changePayMonth(d) { payOffset+=d; loadPayTable(); }
    function loadPayTable() {
        document.getElementById('bigPayTable').innerHTML="<tr><td style='padding:20px;color:#fff'>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã...</td></tr>";
        fetch(API+"?action=get_all_stats_month&offset="+payOffset).then(r=>r.json()).then(d=>{
            payFullData=d; document.getElementById('payTableMonth').innerText=d.monthLabel;
            let h="<tr><th class='name-col'>–§–ò–û</th>"; for(let i=1;i<=d.daysInMonth;i++) h+=`<th>${i}</th>`; h+="<th>–î–Ω</th><th>–û–±</th></tr>";
            Object.keys(d.stats).sort().forEach(n=>{
                let u=d.stats[n];
                h+=`<tr><td class='name-col' onclick="openPayControl('${n}',${u.paidLimit})">${n}</td>`;
                for(let i=1;i<=d.daysInMonth;i++) {
                    let bg="", val="";
                    // –õ–æ–≥–∏–∫–∞ —Ü–≤–µ—Ç–∞
                    if(i<=u.paidLimit) { bg="bg-paid"; } 
                    else if(u.days[i]) { bg="bg-ok"; }
                    else if(d.limitDay>0 && i<=d.limitDay) { bg="bg-miss"; val="X"; }
                    
                    // –õ–æ–≥–∏–∫–∞ —Ü–∏—Ñ—Ä (–û—Å—Ç–∞–≤–ª—è–µ–º —Ü–∏—Ñ—Ä—É –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–æ–∑–æ–≤—ã–π)
                    if(u.days[i]) val = u.days[i]; 
                    
                    h+=`<td class="${bg}">${val}</td>`;
                }
                h+=`<td>${u.totalD}</td><td>${u.totalV}</td></tr>`;
            });
            document.getElementById('bigPayTable').innerHTML=h;
        });
    }
    function openPayControl(name, limit) {
        payCurrentName=name; document.getElementById('payControlName').innerText=name;
        let s=document.getElementById('paySlider'); s.max=payFullData.daysInMonth; s.value=limit;
        document.getElementById('sliderVal').innerText=limit;
        document.getElementById('payControl').style.display='block';
    }
    function savePayment(sendToTg) {
        let btnStr = sendToTg ? "–û–¢–ü–†–ê–í–ö–ê..." : "–°–û–•–†–ê–ù–ï–ù–ò–ï...";
        showToast(btnStr);
        let limit = document.getElementById('paySlider').value;
        let month = document.getElementById('payTableMonth').innerText;
        let p=new URLSearchParams(); p.append('action','save_payment'); p.append('name',payCurrentName); p.append('month',month); p.append('limit',limit);
        fetch(API,{method:'POST', body:p}).then(r=>r.json()).then(()=>{
            if(sendToTg) {
                fetch(API+"?action=send_tg_report&month="+month).then(()=>{ showToast("–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"); });
            } else { showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); }
            document.getElementById('payControl').style.display='none';
            loadPayTable();
        });
    }

    // --- –ê–î–ú–ò–ù–ö–ê ---
    function loadReq() {
        document.getElementById('list').innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get").then(r=>r.json()).then(d=>{
            if(d.stats) { document.getElementById('st-dnevka').innerText=d.stats.dnevka; document.getElementById('st-volume').innerText=d.stats.volume; document.getElementById('st-miss').innerText=d.stats.missing; }
            let h=""; d.data.reverse().forEach(i=>{
               h+=`<div style="background:#222; padding:10px; margin-bottom:5px; border-left:3px solid var(--gold-mid); text-align:left">
               <b>${i['–§–∞–º–∏–ª–∏—è –ò–º—è']}</b> <span style="float:right; font-size:0.8em; color:#777">${i['–î–∞—Ç–∞']}</span><br>
               <span style="color:#aaa">${i['–í–∏–¥ —Ä–∞–±–æ—Ç']} (${i['–ö–æ–ª-–≤–æ –ª—é–¥–µ–π']})</span>
               <div style="margin-top:10px; text-align:right">
               <button class="btn-small" style="background:#2e7d32; color:#fff" onclick="upd('${i.ID}','–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">OK</button>
               <button class="btn-small" style="background:#c62828; color:#fff" onclick="upd('${i.ID}','–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')">NO</button>
               <button class="btn-small" onclick="del('${i.ID}')">DEL</button></div></div>`;
            });
            document.getElementById('list').innerHTML = h || "–ù–µ—Ç –∑–∞—è–≤–æ–∫";
        });
    }
    function upd(id,st){ if(confirm(st+"?")) fetch(API+"?action=update&id="+id+"&status="+st,{method:'POST'}).then(loadReq); }
    function del(id){ if(confirm("–£–¥–∞–ª–∏—Ç—å?")) fetch(API+"?action=delete_row&id="+id,{method:'POST'}).then(loadReq); }
    function dl(type) { 
        let offset = 0; 
        if(document.getElementById('paymentPanel').style.display === 'block') offset = payOffset;
        window.open(API+"?action=get_"+type+"&offset="+offset, '_blank'); 
    }

    // --- –®–¢–ê–¢ ---
    function openStaffModal() { document.getElementById('staffModal').style.display='flex'; loadStaff(); }
    function loadStaff() {
        document.getElementById('staffList').innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞...";
        fetch(API+"?action=get_staff_list").then(r=>r.json()).then(d=>{
            let h=""; d.staff.forEach(s=>{
                let fired = s.status==="Fired";
                h+=`<div style="padding:8px; border-bottom:1px solid #333; display:flex; justify-content:space-between">
                <span style="${fired?'text-decoration:line-through;color:#555':''}">${s.name}</span>
                <button class="btn-small" onclick="${fired?'res':'fire'}Emp('${s.name}')" style="background:${fired?'#2e7d32':'#c62828'};color:#fff">${fired?'–í–ï–†–ù–£–¢–¨':'–£–í–û–õ–ò–¢–¨'}</button></div>`;
            });
            document.getElementById('staffList').innerHTML=h;
        });
    }
    function addEmployee(){ let n=document.getElementById('newEmpName').value; if(n) fetch(API+"?action=add_employee&name="+encodeURIComponent(n),{method:'POST'}).then(()=>{document.getElementById('newEmpName').value=''; loadStaff();}); }
    function fireEmp(n){ if(confirm("–£–≤–æ–ª–∏—Ç—å?")) fetch(API+"?action=fire_employee&name="+encodeURIComponent(n),{method:'POST'}).then(loadStaff); }
    function resEmp(n){ if(confirm("–í–µ—Ä–Ω—É—Ç—å?")) fetch(API+"?action=restore_employee&name="+encodeURIComponent(n),{method:'POST'}).then(loadStaff); }

    // --- –°–ò–°–¢–ï–ú–ù–û–ï ---
    function openAuth(){ document.getElementById('authModal').style.display='flex'; }
    function closeM(id){ document.getElementById(id).style.display='none'; }
    function showToast(msg){ let t=document.getElementById('toast'); t.innerText=msg; t.className='show'; setTimeout(()=>t.className='',3000); }
    function login(){
        let p=document.getElementById('pass').value;
        if(p==="westprom123") { localStorage.setItem('wp_admin_auth','main'); location.reload(); }
        else if(p==="money777") { localStorage.setItem('wp_admin_auth','payment'); location.reload(); }
        else alert("–ù–µ–≤–µ—Ä–Ω–æ");
    }
    function logout(){ if(confirm("–í—ã–π—Ç–∏?")) { localStorage.removeItem('wp_admin_auth'); location.reload(); } }
</script>

</body>
</html>
